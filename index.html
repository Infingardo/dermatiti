<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DermPath v1.5 - Dermatiti Eosinofile</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-family: system-ui, -apple-system, sans-serif; line-height: 1.5; }
        .min-h-screen { min-height: 100vh; }
        .max-w-4xl { max-width: 56rem; margin-left: auto; margin-right: auto; }
        .flex { display: flex; }
        .flex-1 { flex: 1 1 0%; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .block { display: block; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-5 { padding: 1.25rem; }
        .p-6 { padding: 1.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .ml-4 { margin-left: 1rem; }
        .mr-3 { margin-right: 0.75rem; }
        .mx-2 { margin-left: 0.5rem; margin-right: 0.5rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .w-full { width: 100%; }
        .w-10 { width: 2.5rem; }
        .h-1 { height: 0.25rem; }
        .h-10 { height: 2.5rem; }
        .h-24 { height: 6rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .italic { font-style: italic; }
        .text-center { text-align: center; }
        .underline { text-decoration: underline; }
        .text-white { color: #fff; }
        .text-slate-500 { color: #64748b; }
        .text-slate-600 { color: #475569; }
        .text-slate-700 { color: #334155; }
        .text-slate-800 { color: #1e293b; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-700 { color: #1d4ed8; }
        .text-blue-800 { color: #1e40af; }
        .text-blue-900 { color: #1e3a8a; }
        .text-red-800 { color: #991b1b; }
        .text-red-900 { color: #7f1d1d; }
        .text-amber-800 { color: #92400e; }
        .text-amber-900 { color: #78350f; }
        .text-orange-800 { color: #9a3412; }
        .bg-white { background-color: #fff; }
        .bg-slate-50 { background-color: #f8fafc; }
        .bg-slate-100 { background-color: #f1f5f9; }
        .bg-slate-200 { background-color: #e2e8f0; }
        .bg-slate-300 { background-color: #cbd5e1; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-700 { background-color: #1d4ed8; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-green-700 { background-color: #15803d; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-red-100 { background-color: #fee2e2; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-amber-50 { background-color: #fffbeb; }
        .bg-amber-100 { background-color: #fef3c7; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-orange-50 { background-color: #fff7ed; }
        .bg-orange-100 { background-color: #ffedd5; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-50 { --tw-gradient-from: #eff6ff; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, transparent); }
        .to-indigo-100 { --tw-gradient-to: #e0e7ff; }
        .border { border-width: 1px; }
        .border-2 { border-width: 2px; }
        .border-slate-200 { border-color: #e2e8f0; }
        .border-blue-200 { border-color: #bfdbfe; }
        .border-blue-600 { border-color: #2563eb; }
        .border-green-500 { border-color: #22c55e; }
        .border-red-200 { border-color: #fecaca; }
        .border-red-300 { border-color: #fca5a5; }
        .border-red-500 { border-color: #ef4444; }
        .border-amber-200 { border-color: #fde68a; }
        .border-amber-500 { border-color: #f59e0b; }
        .border-orange-200 { border-color: #fed7aa; }
        .border-orange-500 { border-color: #f97316; }
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-full { border-radius: 9999px; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); }
        .cursor-pointer { cursor: pointer; }
        button, select, input[type="checkbox"] { cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .hover\:bg-slate-50:hover { background-color: #f8fafc; }
        .hover\:bg-slate-100:hover { background-color: #f1f5f9; }
        .hover\:bg-slate-200:hover { background-color: #e2e8f0; }
        .hover\:bg-slate-300:hover { background-color: #cbd5e1; }
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .hover\:bg-amber-50:hover { background-color: #fffbeb; }
        .hover\:bg-red-50:hover { background-color: #fef2f2; }
        .hover\:bg-orange-50:hover { background-color: #fff7ed; }
        .hover\:border-blue-300:hover { border-color: #93c5fd; }
        .hover\:underline:hover { text-decoration: underline; }
        .focus\:border-blue-500:focus { border-color: #3b82f6; outline: none; }
        select, input[type="text"], textarea {
            width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 1rem;
        }
        select:focus, input[type="text"]:focus, textarea:focus { border-color: #3b82f6; outline: none; }
        input[type="checkbox"] { width: 1rem; height: 1rem; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useCallback, memo } = React;

        const SCORING_CONFIG = {
            MAJOR_WEIGHT: 3, MINOR_WEIGHT: 1, SOFT_MATCH_PENALTY: 0.9,
            RED_FLAG_PENALTY: 25, MIN_SCORE_AFTER_EXCLUSION: 5, THRESHOLD_PERCENTAGE: 50
        };

        const INITIAL_STATE = {
            pattern_primario: '', spongiosi: '', esocitosi: '', acantosi: '',
            paracheratosi: '', ipergranulosi: '', ipogranulosi: '',
            vacuolizzazione_basale: '', necrosi_keratinociti: '',
            infiltrato_distribuzione: '', infiltrato_densita: '',
            eosinofili: '', neutrofili: '', linfociti_atipici: '',
            epidermotropismo: '', alone_chiaro: false, cellule_cerebriformi: false,
            cd30_positivi: false, microascessi_munro: false, vasculite: '',
            eritrociti_extravasati: '', sede_anatomica: '', note_cliniche: '',
            edema_dermico: '', palisading_necrosi_mucina: false,
            microvescicole: false, corpi_civatte: false,
            acantolisi: false, bolle_intraepidermiche: false, bolle_subepidermiche: false,
            infiltrato_neutrofili_pustole: false,
            flame_figures: false, infiltrato_wedge_shaped: false,
            eosinofili_perivascolari_profondi: false, degranulazione_eosinofila: false,
            necrosi_epidermica_focale: false, storia_farmaci: false, storia_puntura_insetto: false,
            fibrosi_dermica: false, iperplasia_neurale: false,
            infiltrato_follicolare: false, spongiosi_follicolare: false, pustole_follicolari: false,
            paracheratosi_a_spalla: false, croste_perifollicolari: false, ballooning_cheratinociti: false, croste_sierose: false
        };

        const PATTERN_OPTIONS = [
            { value: 'spongotico', label: 'Spongotico', desc: 'Edema intercellulare' },
            { value: 'psoriasiforme', label: 'Psoriasiforme', desc: 'Allungamento rete ridges' },
            { value: 'interfaccia_lichenoide', label: 'Interfaccia Lichenoide', desc: 'Infiltrato a banda' },
            { value: 'interfaccia_vacuolare', label: 'Interfaccia Vacuolare', desc: 'Vacuoli basali' },
            { value: 'perivascolare', label: 'Perivascolare', desc: 'Infiltrato attorno vasi' },
            { value: 'perivascolare_eosinofilo', label: 'Perivascolare Eosinofilo', desc: 'Eosinofili perivascolari' },
            { value: 'vasculitico', label: 'Vasculitico', desc: 'Danno vascolare' },
            { value: 'granulomatoso', label: 'Granulomatoso', desc: 'Granulomi palisading' },
            { value: 'subcorneo', label: 'Subcorneo', desc: 'Pustole sottocornee' },
            { value: 'intraepidermico', label: 'Intraepidermico', desc: 'Acantolisi' },
            { value: 'subepidermico_bolloso', label: 'Subepidermico Bolloso', desc: 'Bolle subepidermiche' },
            { value: 'interstiziale_eosinofilo', label: 'Interstiziale Eosinofilo', desc: 'Eosinofili diffusi derma' }
        ];

        const RED_FLAGS = [
            { flag: "microascessi_munro", diagnosi: "Psoriasi", escludi: ["dermatite_allergica_contatto", "dermatite_atopica_acuta", "dermatite_seborroica"] },
            { flag: "corpi_civatte", diagnosi: "Lichen planus", escludi: ["psoriasi_vulgaris"] },
            { flag: "eosinofili_marcati_edema", diagnosi: "Dermatite da contatto", escludi: ["psoriasi_vulgaris"] },
            { flag: "palisading_necrosi_mucina", diagnosi: "Granuloma anulare", escludi: ["dermatite_allergica_contatto"] },
            { flag: "epidermotropismo_alone", diagnosi: "Linfoma cutaneo", escludi: ["dermatite_allergica_contatto"] },
            { flag: "acantolisi_bolloso", diagnosi: "Pemfigo volgare - IHC", escludi: ["pemfigoide_bolloso"] },
            { flag: "bolle_subepidermiche_eosinofili", diagnosi: "Pemfigoide bolloso - IF", escludi: ["pemfigo_volgare"] },
            { flag: "flame_figures_eosinofili", diagnosi: "Sindrome di Wells", escludi: ["reazione_puntura_insetto"] },
            { flag: "wedge_eosinofili_profondo", diagnosi: "Reazione da puntura", escludi: ["sindrome_wells"] },
            { flag: "eosinofili_profondi_interfaccia", diagnosi: "Drug reaction eosinofila", escludi: ["reazione_puntura_insetto"] },
            { flag: "paracheratosi_spalla_follicolare", diagnosi: "Dermatite seborroica", escludi: ["psoriasi_vulgaris"] },
            { flag: "necrosi_ballooning_scarso_infiltrato", diagnosi: "Dermatite irritativa (NON allergica)", escludi: ["dermatite_allergica_contatto"] },
            { flag: "sid_pattern_farmaci", diagnosi: "Drug eruption morbilliforme (SID)", escludi: ["esantema_virale"] }
        ];

        const DIAGNOSTIC_PATTERNS = {
            dermatite_allergica_contatto: {
                nome: "Dermatite allergica da contatto",
                categoria: "Spongotico",
                criteri_maggiori: { pattern_primario: "spongotico", spongiosi: ["moderata", "marcata"], esocitosi: "presente" },
                criteri_minori: { eosinofili: ["presenti", "abbondanti"], infiltrato_distribuzione: "perivascolare_superficiale", edema_dermico: ["moderato", "marcato"] },
                note: "Pattern classico ipersensibilit√† tipo IV.",
                colorazioni: ["Nessuna speciale necessaria"],
                bibliografia: { principale: { autori: "Usatine RP, Riojas M", titolo: "Diagnosis and Management of Contact Dermatitis", rivista: "Am Fam Physician", anno: 2010, pmid: "20672788", tipo: "review" }, secondarie: [] }
            },
            dermatite_atopica_acuta: {
                nome: "Dermatite atopica (acuta)",
                categoria: "Spongotico",
                criteri_maggiori: { pattern_primario: "spongotico", spongiosi: ["moderata", "marcata"], esocitosi: "presente" },
                criteri_minori: { eosinofili: ["presenti", "abbondanti"], paracheratosi: "focale" },
                note: "Fase acuta/subacuta. Se cronica: acantosi.",
                colorazioni: ["PAS (escludere dermatofitosi)"],
                bibliografia: { principale: { autori: "Weidinger S, Novak N", titolo: "Atopic Dermatitis", rivista: "Lancet", anno: 2016, pmid: "26377142", tipo: "review" }, secondarie: [] }
            },
            dermatite_seborroica: {
                nome: "Dermatite seborroica",
                categoria: "Misto (Spongotico-Psoriasiforme)",
                criteri_maggiori: { pattern_primario: ["spongotico", "psoriasiforme"], paracheratosi: ["focale", "moderata"], paracheratosi_a_spalla: true },
                criteri_minori: { spongiosi: "lieve", acantosi: ["lieve", "moderata"], croste_perifollicolari: true, neutrofili: "rari" },
                note: "Pattern misto. Paracheratosi 'a spalla' (shoulder parakeratosis) sugli infundiboli √® il CLUE chiave. Croste squamo-crostose perifollicolari. Distribuzione: aree seborroiche (scalpo, pieghe nasolabiali, sopracciglia, torace).",
                colorazioni: ["PAS per escludere Malassezia (spesso presente ma non diagnostica)"],
                bibliografia: { principale: { autori: "Gupta AK, Bluhm R, Cooper EA, Summerbell RC, Batra R", titolo: "Seborrheic dermatitis", rivista: "Dermatol Clin", anno: 2003, volume: "21(3)", pagine: "401-412", pmid: "12956195", tipo: "review" }, secondarie: [{ autori: "Schwartz RA, Janusz CA, Janniger CK", titolo: "Seborrheic dermatitis: an overview", rivista: "Am Fam Physician", anno: 2006, pmid: "16848078", tipo: "review" }] }
            },
            dermatite_irritativa_contatto: {
                nome: "Dermatite irritativa da contatto",
                categoria: "Spongotico/Necrotico",
                criteri_maggiori: { pattern_primario: ["spongotico", "interfaccia_vacuolare"], necrosi_keratinociti: ["presente", "marcata"], spongiosi: ["lieve", "moderata"] },
                criteri_minori: { neutrofili: ["presenti", "abbondanti"], ballooning_cheratinociti: true, infiltrato_densita: "scarso", eosinofili: "assenti" },
                note: "‚ö†Ô∏è DIVERSA dalla allergica! Necrosi epidermica (anche a tutto spessore), ballooning cheratinocitario, infiltrato SCARSO (vs denso nella allergica), neutrofili > linfociti, eosinofili assenti o rari. Assenza latenza (esposizione ‚Üí lesione immediata).",
                colorazioni: ["Nessuna necessaria"],
                bibliografia: { principale: { autori: "Ale SI, Maibach HI", titolo: "Irritant contact dermatitis", rivista: "Rev Environ Health", anno: 2014, volume: "29(3)", pagine: "195-206", doi: "10.1515/reveh-2014-0060", pmid: "25274939", tipo: "review" }, secondarie: [{ autori: "Basketter DA, Marriott M, Gilmour NJ, White IR", titolo: "Strong irritants masquerading as skin allergens", rivista: "Contact Dermatitis", anno: 2004, doi: "10.1111/j.0105-1873.2004.00308.x", tipo: "original" }] }
            },
            dermatite_nummulare: {
                nome: "Dermatite nummulare (eczema discoide)",
                categoria: "Spongotico",
                criteri_maggiori: { pattern_primario: "spongotico", spongiosi: ["moderata", "marcata"], esocitosi: "presente" },
                criteri_minori: { paracheratosi: "focale", acantosi: ["lieve", "moderata"], croste_sierose: true },
                note: "Istologicamente INDISTINGUIBILE dalla DAC. Il pattern √® identico: spongiosi, esocitosi, paracheratosi focale. La diagnosi √® CLINICA: lesioni nummulari (a moneta), circolari, ben demarcate, spesso agli arti. Escludere micosi (PAS) e psoriasi.",
                colorazioni: ["PAS per escludere dermatofitosi"],
                bibliografia: { principale: { autori: "Jiamton S, Tangjaturonrusamee C, Kulthanan K", titolo: "Clinical features and aggravating factors in nummular eczema", rivista: "Indian J Dermatol Venereol Leprol", anno: 2013, volume: "79(3)", pagine: "366-368", pmid: "23619441", tipo: "original" }, secondarie: [] }
            },
            drug_eruption_morbilliforme: {
                nome: "Drug eruption morbilliforme (SID pattern)",
                categoria: "Misto (Spongotico-Interfaccia)",
                criteri_maggiori: { pattern_primario: ["spongotico", "interfaccia_vacuolare"], vacuolizzazione_basale: "presente", spongiosi: ["lieve", "moderata"] },
                criteri_minori: { esocitosi: "presente", eosinofili: ["presenti", "abbondanti"], infiltrato_distribuzione: "perivascolare_superficiale", storia_farmaci: true },
                note: "‚ö†Ô∏è SPONGIOTIC-INTERFACE DERMATITIS (SID): pattern misto caratteristico delle eruzioni morbilliformi da farmaco. Vacuolizzazione FOCALE (non continua), spongiosi lieve-moderata, esocitosi. Eosinofili presenti nel 60% casi. Tempo medio insorgenza: 7-14 giorni dall'inizio farmaco. DD: esantema virale (clinica!).",
                colorazioni: ["Nessuna necessaria"],
                workup_molecolare: "Correlazione anamnesi farmacologica MANDATORIA",
                bibliografia: { principale: { autori: "Weyers W, Metze D", titolo: "Histopathology of drug eruptions - general criteria, common patterns, and differential diagnosis", rivista: "Dermatol Pract Concept", anno: 2011, volume: "1(1)", pagine: "33-47", doi: "10.5826/dpc.0101a09", tipo: "review" }, secondarie: [{ autori: "Corneli HM", titolo: "Morbilliform Drug Eruptions", rivista: "Pediatr Emerg Care", anno: 2020, doi: "10.1097/PEC.0000000000002167", pmid: "32732596", tipo: "review" }] }
            },
            esantema_virale: {
                nome: "Esantema virale",
                categoria: "Misto (Spongotico-Interfaccia)",
                criteri_maggiori: { pattern_primario: ["spongotico", "interfaccia_vacuolare", "perivascolare"], vacuolizzazione_basale: "presente", infiltrato_distribuzione: "perivascolare_superficiale" },
                criteri_minori: { spongiosi: "lieve", esocitosi: "presente", linfociti_atipici: "assenti" },
                note: "Pattern SID lieve. Istologicamente SOVRAPPONIBILE alla drug eruption morbilliforme. La diagnosi √® CLINICA: febbre, sintomi prodromici, distribuzione caratteristica, sierologia. Vacuolizzazione focale, spongiosi minima, infiltrato perivascolare linfocitario. Eosinofili generalmente ASSENTI (vs drug eruption).",
                colorazioni: ["Nessuna necessaria"],
                workup_molecolare: "Sierologia virale se indicata clinicamente (EBV, CMV, HHV6, Parvovirus B19)",
                bibliografia: { principale: { autori: "Drago F, Ciccarese G, Rebora A, Parodi A", titolo: "Atypical exanthems: morphology and laboratory investigations may lead to an aetiological diagnosis", rivista: "Br J Dermatol", anno: 2018, volume: "178(3)", pagine: "e215", doi: "10.1111/bjd.16308", pmid: "29603126", tipo: "review" }, secondarie: [{ autori: "Keighley CL, Saunderson RB, Kok J, Dwyer DE", titolo: "Viral exanthems", rivista: "Curr Opin Infect Dis", anno: 2015, doi: "10.1097/QCO.0000000000000168", pmid: "25918957", tipo: "review" }] }
            },
            psoriasi_vulgaris: {
                nome: "Psoriasi vulgaris",
                categoria: "Psoriasiforme",
                criteri_maggiori: { pattern_primario: "psoriasiforme", acantosi: "marcata", paracheratosi: ["moderata", "marcata"], ipogranulosi: "si" },
                criteri_minori: { neutrofili: ["presenti", "abbondanti"], microascessi_munro: true },
                note: "Allungamento regolare rete ridges. Capillari dilatati.",
                colorazioni: ["PAS per escludere tinea"],
                bibliografia: { principale: { autori: "Armstrong AW, Read C", titolo: "Pathophysiology of Psoriasis", rivista: "JAMA", anno: 2020, pmid: "32427307", tipo: "review" }, secondarie: [] }
            },
            lichen_planus: {
                nome: "Lichen planus",
                categoria: "Interfaccia/Lichenoide",
                criteri_maggiori: { pattern_primario: "interfaccia_lichenoide", infiltrato_distribuzione: "banda_lichenoide", vacuolizzazione_basale: "presente" },
                criteri_minori: { necrosi_keratinociti: "presente", ipergranulosi: "si" },
                note: "Infiltrato a banda. Corpi di Civatte.",
                colorazioni: ["PAS per escludere GVHD"],
                bibliografia: { principale: { autori: "Gupta S, Jawanda MK", titolo: "Oral Lichen Planus", rivista: "Indian J Dermatol", anno: 2015, pmid: "26120146", tipo: "review" }, secondarie: [] }
            },
            eritema_multiforme: {
                nome: "Eritema multiforme",
                categoria: "Interfaccia",
                criteri_maggiori: { pattern_primario: "interfaccia_lichenoide", necrosi_keratinociti: "marcata", vacuolizzazione_basale: "presente" },
                criteri_minori: { eosinofili: "presenti" },
                note: "Necrosi cheratinocitaria massiva. Post-HSV o farmaci.",
                colorazioni: [],
                bibliografia: { principale: { autori: "Sokumbi O, Wetter DA", titolo: "Clinical features of EM", rivista: "J Am Acad Dermatol", anno: 2012, pmid: "22177632", tipo: "review" }, secondarie: [] }
            },
            vasculite_leucocitoclastica: {
                nome: "Vasculite leucocitoclastica",
                categoria: "Vasculitico",
                criteri_maggiori: { pattern_primario: "perivascolare", vasculite: "si", neutrofili: "abbondanti" },
                criteri_minori: { eritrociti_extravasati: "presenti" },
                note: "Porpora palpabile. Indagare infezioni, farmaci.",
                colorazioni: ["PAS per depositi vascolari"],
                bibliografia: { principale: { autori: "Sunderk√∂tter CH et al.", titolo: "Nomenclature of Cutaneous Vasculitis", rivista: "Arthritis Rheumatol", anno: 2018, pmid: "29266783", tipo: "consensus" }, secondarie: [] }
            },
            reazione_puntura_insetto: {
                nome: "Reazione da puntura d'artropode",
                categoria: "Eosinofilo",
                criteri_maggiori: { pattern_primario: ["perivascolare_eosinofilo", "perivascolare", "interstiziale_eosinofilo"], eosinofili: "abbondanti", infiltrato_distribuzione: ["perivascolare_superficiale", "perivascolare_profondo"] },
                criteri_minori: { edema_dermico: ["moderato", "marcato"], infiltrato_wedge_shaped: true, spongiosi: ["lieve", "moderata"], necrosi_epidermica_focale: true, storia_puntura_insetto: true },
                note: "Pattern wedge-shaped con vertice profondo. Eosinofili + linfociti. Possibile necrosi epidermica focale.",
                colorazioni: ["Giemsa se sospetto leishmaniosi"],
                bibliografia: { principale: { autori: "Miteva M, Elsner P", titolo: "Arthropod Bite Reactions", rivista: "Dermatol Ther", anno: 2012, pmid: "22741932", tipo: "review" }, secondarie: [{ autori: "Alsaleh QA et al.", titolo: "Cutaneous reactions to arthropod bites", rivista: "J Am Acad Dermatol", anno: 1984, pmid: "6143765", tipo: "original" }] }
            },
            sindrome_wells: {
                nome: "Sindrome di Wells (Cellulite eosinofila)",
                categoria: "Eosinofilo",
                criteri_maggiori: { pattern_primario: ["interstiziale_eosinofilo", "perivascolare_eosinofilo"], eosinofili: "abbondanti", flame_figures: true },
                criteri_minori: { edema_dermico: ["moderato", "marcato"], degranulazione_eosinofila: true, infiltrato_distribuzione: ["perivascolare_profondo", "derma_medio_profondo"] },
                note: "‚ö†Ô∏è FLAME FIGURES patognomoniche: collagene degenerato rivestito da granuli eosinofili. Simula cellulite ma non risponde ad antibiotici.",
                colorazioni: ["H&E sufficiente per flame figures", "Congo rosso per escludere amiloide"],
                bibliografia: { principale: { autori: "R√§√üler F et al.", titolo: "Treatment of eosinophilic cellulitis (Wells syndrome)", rivista: "J Eur Acad Dermatol Venereol", anno: 2016, pmid: "27291961", tipo: "systematic review" }, secondarie: [{ autori: "Wells GC, Smith NP", titolo: "Eosinophilic cellulitis", rivista: "Br J Dermatol", anno: 1979, pmid: "427013", tipo: "original" }] }
            },
            drug_reaction_eosinofila: {
                nome: "Drug reaction con pattern eosinofilo",
                categoria: "Eosinofilo",
                criteri_maggiori: { pattern_primario: ["perivascolare_eosinofilo", "perivascolare", "interfaccia_vacuolare"], eosinofili: ["presenti", "abbondanti"], eosinofili_perivascolari_profondi: true },
                criteri_minori: { infiltrato_distribuzione: ["perivascolare_superficiale", "perivascolare_profondo"], vacuolizzazione_basale: "presente", necrosi_keratinociti: ["presente", "marcata"], storia_farmaci: true },
                note: "‚ö†Ô∏è Eosinofili perivascolari superficiali E profondi = forte sospetto drug. NON √® DRESS (criteri sistemici), ma pattern istologico. Correlazione farmacologica MANDATORIA.",
                colorazioni: ["Nessuna necessaria"],
                workup_molecolare: "Correlazione anamnesi farmacologica. Patch test farmaco sospetto.",
                bibliografia: { principale: { autori: "Mockenhaupt M", titolo: "Epidemiology of cutaneous adverse drug reactions", rivista: "Allergol Select", anno: 2017, pmid: "30402608", tipo: "review" }, secondarie: [{ autori: "Weyers W, Metze D", titolo: "Histopathology of drug eruptions", rivista: "Dermatol Pract Concept", anno: 2011, doi: "10.5826/dpc.0101a09", tipo: "review" }] }
            },
            orticaria: {
                nome: "Orticaria",
                categoria: "Eosinofilo",
                criteri_maggiori: { pattern_primario: ["perivascolare_eosinofilo", "perivascolare"], edema_dermico: ["moderato", "marcato"], infiltrato_distribuzione: "perivascolare_superficiale" },
                criteri_minori: { eosinofili: ["presenti", "abbondanti"], neutrofili: ["rari", "presenti"], spongiosi: "lieve" },
                note: "Edema dermico marcato con scarso infiltrato perivascolare (linfociti, eosinofili, neutrofili). L'epidermide √® tipicamente normale o con minima spongiosi. Pattern \"cell-poor\" con edema prominente. Clinica: pomfi evanescenti <24h.",
                colorazioni: ["Nessuna necessaria"],
                bibliografia: { principale: { autori: "Zuberbier T, Abdul Latiff AH, et al.", titolo: "The international EAACI/GA¬≤LEN/EuroGuiDerm/APAAACI guideline for the definition, classification, diagnosis, and management of urticaria", rivista: "Allergy", anno: 2022, volume: "77(3)", pagine: "734-766", doi: "10.1111/all.15090", pmid: "34536239", tipo: "guidelines" }, secondarie: [{ autori: "Kaplan AP, Greaves M", titolo: "Pathogenesis of chronic urticaria", rivista: "Clin Exp Allergy", anno: 2009, doi: "10.1111/j.1365-2222.2009.03215.x", tipo: "review" }] }
            },
            prurigo_nodularis: {
                nome: "Prurigo nodularis",
                categoria: "Eosinofilo",
                criteri_maggiori: { pattern_primario: ["perivascolare", "perivascolare_eosinofilo"], acantosi: ["moderata", "marcata"], ipergranulosi: "si" },
                criteri_minori: { eosinofili: ["presenti", "abbondanti"], paracheratosi: ["focale", "moderata"], fibrosi_dermica: true, iperplasia_neurale: true },
                note: "Epidermide iperplastica con ipergranulosi compatta e paracheratosi. Derma con fibrosi verticale e infiltrato perivascolare con eosinofili. Possibile iperplasia neurale. Pattern \"lichenificato\" cronico. Escludere dermatite atopica sottostante.",
                colorazioni: ["S100 o PGP9.5 se sospetto iperplasia neurale"],
                bibliografia: { principale: { autori: "Williams KA, Huang AH, Belzberg M, Kwatra SG", titolo: "Prurigo nodularis: Pathogenesis and management", rivista: "J Am Acad Dermatol", anno: 2020, volume: "83(6)", pagine: "1567-1575", doi: "10.1016/j.jaad.2020.04.182", pmid: "32461078", tipo: "review" }, secondarie: [{ autori: "Pereira MP, St√§nder S", titolo: "Chronic Prurigo: Pathogenesis, Clinical Aspects and Treatment", rivista: "J Dtsch Dermatol Ges", anno: 2023, doi: "10.1111/ddg.15004", tipo: "review" }] }
            },
            follicolite_eosinofila: {
                nome: "Follicolite eosinofila (Ofuji / HIV-associata)",
                categoria: "Eosinofilo",
                criteri_maggiori: { pattern_primario: ["perivascolare_eosinofilo", "interstiziale_eosinofilo"], eosinofili: "abbondanti", infiltrato_follicolare: true },
                criteri_minori: { spongiosi_follicolare: true, pustole_follicolari: true, degranulazione_eosinofila: true },
                note: "‚ö†Ô∏è Infiltrato eosinofilo centrato sui follicoli con spongiosi follicolare e possibili pustole. Variante classica (Ofuji): Giappone, recidivante, viso. Variante HIV: prurito intenso, CD4 <300, parte superiore tronco. Escludere altre follicoliti.",
                colorazioni: ["PAS/Grocott per escludere funghi", "Gram per batteri"],
                workup_molecolare: "Sierologia HIV se non nota. CD4 count.",
                bibliografia: { principale: { autori: "Nervi SJ, Schwartz RA, Dmochowski M", titolo: "Eosinophilic pustular folliculitis: a 40 year retrospect", rivista: "J Am Acad Dermatol", anno: 2006, volume: "55(2)", pagine: "285-289", doi: "10.1016/j.jaad.2006.02.035", pmid: "16844513", tipo: "review" }, secondarie: [{ autori: "Ofuji S, Ogino A, Horio T, Oseko T, Uehara M", titolo: "Eosinophilic pustular folliculitis", rivista: "Acta Derm Venereol", anno: 1970, pmid: "4195865", tipo: "original" }, { autori: "Rosenthal D, LeBoit PE, Klumpp L, Berger TG", titolo: "Human immunodeficiency virus-associated eosinophilic folliculitis", rivista: "Arch Dermatol", anno: 1991, pmid: "1952969", tipo: "case series" }] }
            },
            micosi_fungoide_early: {
                nome: "Micosi fungoide (early)",
                categoria: "Linfoma cutaneo T",
                criteri_maggiori: { pattern_primario: ["spongotico", "interfaccia_lichenoide"], infiltrato_distribuzione: ["perivascolare_superficiale", "banda_lichenoide"], linfociti_atipici: "presenti" },
                criteri_minori: { epidermotropismo: "presente", alone_chiaro: true },
                note: "‚ö†Ô∏è LINFOMA! Linfociti atipici epidermotropi con alone chiaro.",
                colorazioni: ["IHC: CD3+, CD4+>CD8+, CD7 loss"],
                workup_molecolare: "PCR riarrangiamento TCR",
                bibliografia: { principale: { autori: "Willemze R et al.", titolo: "WHO-EORTC classification cutaneous lymphomas", rivista: "Blood", anno: 2019, pmid: "30635287", tipo: "guidelines" }, secondarie: [] }
            },
            granuloma_anulare: {
                nome: "Granuloma anulare",
                categoria: "Granulomatoso",
                criteri_maggiori: { pattern_primario: "granulomatoso", palisading_necrosi_mucina: true, infiltrato_distribuzione: "derma_medio_profondo" },
                criteri_minori: {},
                note: "Palisading granulomi con necrosi mucinosa centrale.",
                colorazioni: ["PAS (escludere infezioni)", "Alcian blue (mucina)"],
                bibliografia: { principale: { autori: "Piette EW, Rosenbach M", titolo: "Granuloma Annulare", rivista: "J Am Acad Dermatol", anno: 2016, pmid: "27021234", tipo: "review" }, secondarie: [] }
            },
            pemfigo_volgare: {
                nome: "Pemfigo volgare",
                categoria: "Bolloso Intraepidermico",
                criteri_maggiori: { pattern_primario: "intraepidermico", acantolisi: true, bolle_intraepidermiche: true },
                criteri_minori: { necrosi_keratinociti: "presente" },
                note: "‚ö†Ô∏è Acantolisi. IHC MANDATORIA.",
                colorazioni: ["IHC: Desmogleina 3"],
                workup_molecolare: "Sierologia anti-desmogleina",
                bibliografia: { principale: { autori: "Joly P et al.", titolo: "S2K guidelines pemphigus", rivista: "J Eur Acad Dermatol Venereol", anno: 2020, pmid: "32686180", tipo: "guidelines" }, secondarie: [] }
            },
            pemfigoide_bolloso: {
                nome: "Pemfigoide bolloso",
                categoria: "Bolloso Subepidermico",
                criteri_maggiori: { pattern_primario: "subepidermico_bolloso", bolle_subepidermiche: true, infiltrato_distribuzione: "giunzione_dermoepidermica" },
                criteri_minori: { eosinofili: ["presenti", "abbondanti"] },
                note: "‚ö†Ô∏è Bolle subepidermiche. IF MANDATORIA.",
                colorazioni: ["IF: IgG + C3 lineari"],
                bibliografia: { principale: { autori: "Schmidt E et al.", titolo: "Pemphigus and Pemphigoid Meeting", rivista: "J Invest Dermatol", anno: 2016, pmid: "26763419", tipo: "consensus" }, secondarie: [] }
            }
        };

        const DiagnosticEngine = {
            evaluateRedFlag(flag, data) {
                const checks = {
                    microascessi_munro: () => data.microascessi_munro === true,
                    corpi_civatte: () => data.corpi_civatte === true,
                    eosinofili_marcati_edema: () => data.eosinofili === "abbondanti" && data.edema_dermico === "marcato",
                    palisading_necrosi_mucina: () => data.palisading_necrosi_mucina === true,
                    epidermotropismo_alone: () => data.epidermotropismo === "presente" && data.alone_chiaro === true,
                    acantolisi_bolloso: () => data.acantolisi === true && data.bolle_intraepidermiche === true,
                    bolle_subepidermiche_eosinofili: () => data.bolle_subepidermiche === true && (data.eosinofili === "presenti" || data.eosinofili === "abbondanti"),
                    flame_figures_eosinofili: () => data.flame_figures === true && data.eosinofili === "abbondanti",
                    wedge_eosinofili_profondo: () => data.infiltrato_wedge_shaped === true && data.eosinofili === "abbondanti",
                    eosinofili_profondi_interfaccia: () => data.eosinofili_perivascolari_profondi === true && (data.eosinofili === "presenti" || data.eosinofili === "abbondanti"),
                    paracheratosi_spalla_follicolare: () => data.paracheratosi_a_spalla === true && data.croste_perifollicolari === true,
                    necrosi_ballooning_scarso_infiltrato: () => data.ballooning_cheratinociti === true && data.infiltrato_densita === "scarso" && (data.necrosi_keratinociti === "presente" || data.necrosi_keratinociti === "marcata"),
                    sid_pattern_farmaci: () => data.vacuolizzazione_basale === "presente" && (data.spongiosi === "lieve" || data.spongiosi === "moderata") && data.storia_farmaci === true
                };
                return checks[flag] ? checks[flag]() : false;
            },
            calculateCriteriaScore(criterio, valoreAtteso, valoreCorrente, weight) {
                if (Array.isArray(valoreAtteso)) {
                    if (valoreAtteso.includes(valoreCorrente)) return weight;
                    const softMatches = { spongiosi: ["moderata", "marcata"], acantosi: ["moderata", "marcata"], neutrofili: ["presenti", "abbondanti"], eosinofili: ["presenti", "abbondanti"] };
                    if (softMatches[criterio]) {
                        const [lower, upper] = softMatches[criterio];
                        if (valoreCorrente === lower && valoreAtteso.includes(upper)) return weight * SCORING_CONFIG.SOFT_MATCH_PENALTY;
                    }
                    return 0;
                }
                if (typeof valoreAtteso === 'boolean') return valoreCorrente === valoreAtteso ? weight : 0;
                return valoreCorrente === valoreAtteso ? weight : 0;
            },
            scorePattern(patternKey, pattern, data, isExcluded) {
                let score = 0, maxScore = 0;
                Object.entries(pattern.criteri_maggiori).forEach(([c, v]) => {
                    maxScore += SCORING_CONFIG.MAJOR_WEIGHT;
                    score += this.calculateCriteriaScore(c, v, data[c], SCORING_CONFIG.MAJOR_WEIGHT);
                });
                if (pattern.criteri_minori) {
                    Object.entries(pattern.criteri_minori).forEach(([c, v]) => {
                        maxScore += SCORING_CONFIG.MINOR_WEIGHT;
                        score += this.calculateCriteriaScore(c, v, data[c], SCORING_CONFIG.MINOR_WEIGHT);
                    });
                }
                const pct = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;
                return { percentage: isExcluded ? Math.max(SCORING_CONFIG.MIN_SCORE_AFTER_EXCLUSION, pct - SCORING_CONFIG.RED_FLAG_PENALTY) : pct, excluded: isExcluded };
            },
            calculate(data) {
                const activeFlags = RED_FLAGS.filter(rf => this.evaluateRedFlag(rf.flag, data));
                const results = [];
                Object.entries(DIAGNOSTIC_PATTERNS).forEach(([key, pattern]) => {
                    const isExcluded = activeFlags.some(rf => rf.escludi.includes(key));
                    const { percentage, excluded } = this.scorePattern(key, pattern, data, isExcluded);
                    if (percentage >= SCORING_CONFIG.THRESHOLD_PERCENTAGE) {
                        results.push({ key, ...pattern, percentuale: percentage, excluded });
                    }
                });
                results.sort((a, b) => b.percentuale - a.percentuale);
                return { diagnoses: results, activeFlags };
            }
        };

        const useMultiStepForm = (initialStep = 1) => {
            const [step, setStep] = useState(initialStep);
            return { step, nextStep: useCallback(() => setStep(s => s + 1), []), prevStep: useCallback(() => setStep(s => s - 1), []), reset: useCallback(() => setStep(initialStep), [initialStep]) };
        };

        const useDiagnosticData = () => {
            const [data, setData] = useState(INITIAL_STATE);
            return { data, updateField: useCallback((f, v) => setData(prev => ({ ...prev, [f]: v })), []), reset: useCallback(() => setData(INITIAL_STATE), []) };
        };

        const SelectField = memo(({ label, value, onChange, options }) => (
            <div>
                <label className="block font-semibold mb-2">{label}</label>
                <select value={value} onChange={(e) => onChange(e.target.value)}>
                    <option value="">Seleziona...</option>
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        ));

        const CheckboxField = memo(({ label, checked, onChange, variant = "default" }) => {
            const colors = { default: "border-slate-200 hover:bg-slate-50", warning: "border-amber-200 hover:bg-amber-50", danger: "border-red-300 hover:bg-red-50", eosinophil: "border-orange-200 hover:bg-orange-50" };
            return (
                <label className={`flex items-center p-3 border-2 rounded-lg cursor-pointer ${colors[variant]}`}>
                    <input type="checkbox" checked={checked} onChange={(e) => onChange(e.target.checked)} className="mr-3" />
                    <span className={variant === "danger" ? "font-semibold" : ""}>{label}</span>
                </label>
            );
        });

        const RadioOption = memo(({ option, selected, onSelect }) => (
            <label className={`flex items-start p-4 border-2 rounded-lg cursor-pointer ${selected ? 'border-blue-600 bg-blue-50' : 'border-slate-200 hover:border-blue-300'}`}>
                <input type="radio" value={option.value} checked={selected} onChange={() => onSelect(option.value)} className="mt-1 mr-3" />
                <div><div className="font-semibold">{option.label}</div><div className="text-sm text-slate-600">{option.desc}</div></div>
            </label>
        ));

        const StepIndicator = memo(({ currentStep }) => (
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div className="flex items-center justify-between mb-2">
                    {[1,2,3,4].map(s => (
                        <div key={s} className="flex items-center flex-1">
                            <div className={`w-10 h-10 rounded-full flex items-center font-bold ${currentStep >= s ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}`} style={{justifyContent:'center'}}>{s}</div>
                            {s < 4 && <div className={`flex-1 h-1 mx-2 ${currentStep > s ? 'bg-blue-600' : 'bg-slate-200'}`} />}
                        </div>
                    ))}
                </div>
                <div className="flex justify-between text-xs text-slate-600 mt-2"><span>Pattern</span><span>Epidermide</span><span>Infiltrato</span><span>Finalizza</span></div>
            </div>
        ));

        const NavigationButtons = memo(({ onBack, onNext, canGoNext = true, nextLabel = "Avanti ‚Üí" }) => (
            <div className="flex gap-4 mt-6">
                {onBack && <button onClick={onBack} className="flex-1 bg-slate-200 py-3 rounded-lg font-semibold hover:bg-slate-300">‚Üê Indietro</button>}
                <button onClick={onNext} disabled={!canGoNext} className={`flex-1 py-3 rounded-lg font-semibold ${nextLabel.includes('Genera') ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white`} style={!canGoNext ? {opacity: 0.5, cursor: 'not-allowed'} : {}}>{nextLabel}</button>
            </div>
        ));

        const BibliographySection = memo(({ bibliografia }) => {
            const [expanded, setExpanded] = useState(false);
            if (typeof bibliografia === 'string') return <div className="mt-3 p-3 bg-slate-50 rounded"><p className="text-xs text-slate-600 italic">üìö {bibliografia}</p></div>;
            const { principale, secondarie = [] } = bibliografia;
            const fmt = (r) => `${r.autori}. "${r.titolo}". ${r.rivista} (${r.anno}).`;
            return (
                <div className="mt-3 border-t border-slate-200 pt-3">
                    <button onClick={() => setExpanded(!expanded)} className="flex items-center justify-between w-full text-left p-2 bg-slate-50 rounded hover:bg-slate-100">
                        <span className="text-sm font-semibold text-slate-700">üìö Bibliografia {secondarie.length > 0 && `(${1 + secondarie.length})`}</span>
                        <span className="text-slate-500">{expanded ? '‚ñº' : '‚ñ∂'}</span>
                    </button>
                    {expanded && (
                        <div className="mt-2 space-y-3 p-3 bg-white border border-slate-200 rounded">
                            <div>
                                <span className="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs font-semibold rounded">PRINCIPALE</span>
                                {principale.tipo && <span className="text-xs text-slate-500 italic ml-2">[{principale.tipo}]</span>}
                                <p className="text-xs text-slate-700 mt-1">{fmt(principale)}</p>
                                <div className="flex gap-3 mt-1">
                                    {principale.doi && <a href={`https://doi.org/${principale.doi}`} target="_blank" className="text-xs text-blue-600 hover:underline">DOI</a>}
                                    {principale.pmid && <a href={`https://pubmed.ncbi.nlm.nih.gov/${principale.pmid}`} target="_blank" className="text-xs text-blue-600 hover:underline">PMID: {principale.pmid}</a>}
                                </div>
                            </div>
                            {secondarie.length > 0 && <div className="border-t border-slate-200 pt-2"><p className="text-xs font-semibold text-slate-600 mb-2">Altre:</p>
                                {secondarie.map((ref, i) => <div key={i} className="mb-2 pl-3 border-l-2 border-slate-200"><p className="text-xs text-slate-700">{fmt(ref)}</p></div>)}
                            </div>}
                        </div>
                    )}
                </div>
            );
        });

        const PatternStep = memo(({ data, updateField, onNext }) => (
            <div>
                <h2 className="text-2xl font-bold mb-4">Pattern Architetturale</h2>
                <div className="space-y-3">{PATTERN_OPTIONS.map(opt => <RadioOption key={opt.value} option={opt} selected={data.pattern_primario === opt.value} onSelect={(v) => updateField('pattern_primario', v)} />)}</div>
                <NavigationButtons onNext={onNext} canGoNext={!!data.pattern_primario} />
            </div>
        ));

        const EpidermalStep = memo(({ data, updateField, onBack, onNext }) => (
            <div>
                <h2 className="text-2xl font-bold mb-4">Epidermide</h2>
                <div className="space-y-4">
                    <SelectField label="Spongiosi" value={data.spongiosi} onChange={(v) => updateField('spongiosi', v)} options={[{value:'assente',label:'Assente'},{value:'lieve',label:'Lieve'},{value:'moderata',label:'Moderata'},{value:'marcata',label:'Marcata'}]} />
                    <SelectField label="Esocitosi" value={data.esocitosi} onChange={(v) => updateField('esocitosi', v)} options={[{value:'assente',label:'Assente'},{value:'lieve',label:'Lieve'},{value:'presente',label:'Presente'},{value:'marcata',label:'Marcata'}]} />
                    <SelectField label="Acantosi" value={data.acantosi} onChange={(v) => updateField('acantosi', v)} options={[{value:'assente',label:'Assente'},{value:'lieve',label:'Lieve'},{value:'moderata',label:'Moderata'},{value:'marcata',label:'Marcata'}]} />
                    <SelectField label="Paracheratosi" value={data.paracheratosi} onChange={(v) => updateField('paracheratosi', v)} options={[{value:'assente',label:'Assente'},{value:'focale',label:'Focale'},{value:'moderata',label:'Moderata'},{value:'marcata',label:'Marcata'}]} />
                    <div className="grid grid-cols-2 gap-4">
                        <SelectField label="Ipergranulosi" value={data.ipergranulosi} onChange={(v) => updateField('ipergranulosi', v)} options={[{value:'no',label:'No'},{value:'si',label:'S√¨'}]} />
                        <SelectField label="Ipogranulosi" value={data.ipogranulosi} onChange={(v) => updateField('ipogranulosi', v)} options={[{value:'no',label:'No'},{value:'si',label:'S√¨'}]} />
                    </div>
                    <SelectField label="Vacuolizzazione basale" value={data.vacuolizzazione_basale} onChange={(v) => updateField('vacuolizzazione_basale', v)} options={[{value:'assente',label:'Assente'},{value:'presente',label:'Presente'},{value:'marcata',label:'Marcata'}]} />
                    <SelectField label="Necrosi cheratinociti" value={data.necrosi_keratinociti} onChange={(v) => updateField('necrosi_keratinociti', v)} options={[{value:'assente',label:'Assente'},{value:'presente',label:'Presente'},{value:'marcata',label:'Marcata'}]} />
                </div>
                <NavigationButtons onBack={onBack} onNext={onNext} />
            </div>
        ));

        const InfiltrateStep = memo(({ data, updateField, onBack, onNext }) => (
            <div>
                <h2 className="text-2xl font-bold mb-4">Derma e Infiltrato</h2>
                <div className="space-y-4">
                    <SelectField label="Distribuzione infiltrato" value={data.infiltrato_distribuzione} onChange={(v) => updateField('infiltrato_distribuzione', v)} options={[{value:'perivascolare_superficiale',label:'Perivascolare superficiale'},{value:'perivascolare_profondo',label:'Perivascolare profondo'},{value:'banda_lichenoide',label:'A banda lichenoide'},{value:'interstiziale',label:'Interstiziale'},{value:'perivascolare_perianessiale',label:'Perivascolare e perianessiale'},{value:'derma_medio_profondo',label:'Derma medio-profondo'},{value:'giunzione_dermoepidermica',label:'Giunzione dermo-epidermica'}]} />
                    <SelectField label="Densit√† infiltrato" value={data.infiltrato_densita} onChange={(v) => updateField('infiltrato_densita', v)} options={[{value:'scarso',label:'Scarso'},{value:'moderato',label:'Moderato'},{value:'denso',label:'Denso'}]} />
                    <SelectField label="Eosinofili" value={data.eosinofili} onChange={(v) => updateField('eosinofili', v)} options={[{value:'assenti',label:'Assenti'},{value:'rari',label:'Rari'},{value:'presenti',label:'Presenti'},{value:'abbondanti',label:'Abbondanti'}]} />
                    <SelectField label="Neutrofili" value={data.neutrofili} onChange={(v) => updateField('neutrofili', v)} options={[{value:'assenti',label:'Assenti'},{value:'rari',label:'Rari'},{value:'presenti',label:'Presenti'},{value:'abbondanti',label:'Abbondanti'}]} />
                    <SelectField label="Eritrociti extravasati" value={data.eritrociti_extravasati} onChange={(v) => updateField('eritrociti_extravasati', v)} options={[{value:'assenti',label:'Assenti'},{value:'presenti',label:'Presenti'},{value:'abbondanti',label:'Abbondanti'}]} />
                    
                    <div className="p-4 bg-orange-50 border-2 border-orange-200 rounded-lg mt-4">
                        <h3 className="font-bold text-orange-800 mb-3">üî∂ Pattern Eosinofilo?</h3>
                        <div className="space-y-3">
                            <CheckboxField label="Flame figures (collagene + granuli) ‚Üí Wells" checked={data.flame_figures} onChange={(v) => updateField('flame_figures', v)} variant="eosinophil" />
                            <CheckboxField label="Infiltrato wedge-shaped (cuneiforme) ‚Üí Bite" checked={data.infiltrato_wedge_shaped} onChange={(v) => updateField('infiltrato_wedge_shaped', v)} variant="eosinophil" />
                            <CheckboxField label="Eosinofili perivascolari profondi ‚Üí Drug" checked={data.eosinofili_perivascolari_profondi} onChange={(v) => updateField('eosinofili_perivascolari_profondi', v)} variant="eosinophil" />
                            <CheckboxField label="Degranulazione eosinofila evidente" checked={data.degranulazione_eosinofila} onChange={(v) => updateField('degranulazione_eosinofila', v)} variant="eosinophil" />
                            <CheckboxField label="Necrosi epidermica focale (punto inoculo)" checked={data.necrosi_epidermica_focale} onChange={(v) => updateField('necrosi_epidermica_focale', v)} variant="eosinophil" />
                            <CheckboxField label="Fibrosi dermica verticale ‚Üí Prurigo" checked={data.fibrosi_dermica} onChange={(v) => updateField('fibrosi_dermica', v)} variant="eosinophil" />
                            <CheckboxField label="Iperplasia neurale ‚Üí Prurigo" checked={data.iperplasia_neurale} onChange={(v) => updateField('iperplasia_neurale', v)} variant="eosinophil" />
                            <CheckboxField label="Infiltrato centrato sui follicoli ‚Üí Follicolite eos." checked={data.infiltrato_follicolare} onChange={(v) => updateField('infiltrato_follicolare', v)} variant="eosinophil" />
                            <CheckboxField label="Spongiosi follicolare" checked={data.spongiosi_follicolare} onChange={(v) => updateField('spongiosi_follicolare', v)} variant="eosinophil" />
                            <CheckboxField label="Pustole follicolari" checked={data.pustole_follicolari} onChange={(v) => updateField('pustole_follicolari', v)} variant="eosinophil" />
                        </div>
                    </div>
                    
                    <div className="p-4 bg-red-50 border-2 border-red-200 rounded-lg mt-4">
                        <h3 className="font-bold text-red-900 mb-3">‚ö†Ô∏è Sospetto Linfoma?</h3>
                        <div className="space-y-3">
                            <SelectField label="Linfociti atipici" value={data.linfociti_atipici} onChange={(v) => updateField('linfociti_atipici', v)} options={[{value:'assenti',label:'Assenti'},{value:'presenti',label:'Presenti'},{value:'abbondanti',label:'Abbondanti'}]} />
                            <SelectField label="Epidermotropismo" value={data.epidermotropismo} onChange={(v) => updateField('epidermotropismo', v)} options={[{value:'assente',label:'Assente'},{value:'presente',label:'Presente'},{value:'marcato',label:'Marcato'}]} />
                            <CheckboxField label="Alone chiaro perinucleare" checked={data.alone_chiaro} onChange={(v) => updateField('alone_chiaro', v)} variant="danger" />
                            <CheckboxField label="Cellule cerebriformi" checked={data.cellule_cerebriformi} onChange={(v) => updateField('cellule_cerebriformi', v)} variant="danger" />
                            <CheckboxField label="CD30+ (se IHC disponibile)" checked={data.cd30_positivi} onChange={(v) => updateField('cd30_positivi', v)} variant="danger" />
                        </div>
                    </div>
                </div>
                <NavigationButtons onBack={onBack} onNext={onNext} />
            </div>
        ));

        const CompletionStep = memo(({ data, updateField, onBack, onGenerate }) => (
            <div>
                <h2 className="text-2xl font-bold mb-4">Completamento</h2>
                <div className="space-y-4">
                    <SelectField label="Vasculite" value={data.vasculite} onChange={(v) => updateField('vasculite', v)} options={[{value:'no',label:'No'},{value:'si',label:'S√¨'}]} />
                    <CheckboxField label="Microascessi di Munro" checked={data.microascessi_munro} onChange={(v) => updateField('microascessi_munro', v)} />
                    <div>
                        <label className="block font-semibold mb-2">üö© Red Flags</label>
                        <div className="space-y-2">
                            <CheckboxField label="Palisading + necrosi mucinosa ‚Üí GA" checked={data.palisading_necrosi_mucina} onChange={(v) => updateField('palisading_necrosi_mucina', v)} variant="warning" />
                            <CheckboxField label="Microvescicole ‚Üí Eczema acuto" checked={data.microvescicole} onChange={(v) => updateField('microvescicole', v)} variant="warning" />
                            <CheckboxField label="Corpi di Civatte ‚Üí LP" checked={data.corpi_civatte} onChange={(v) => updateField('corpi_civatte', v)} variant="warning" />
                            <CheckboxField label="‚ö†Ô∏è Acantolisi ‚Üí PEMFIGO" checked={data.acantolisi} onChange={(v) => updateField('acantolisi', v)} variant="danger" />
                            <CheckboxField label="‚ö†Ô∏è Bolle intraepidermiche" checked={data.bolle_intraepidermiche} onChange={(v) => updateField('bolle_intraepidermiche', v)} variant="danger" />
                            <CheckboxField label="‚ö†Ô∏è Bolle subepidermiche ‚Üí PEMFIGOIDE" checked={data.bolle_subepidermiche} onChange={(v) => updateField('bolle_subepidermiche', v)} variant="danger" />
                            <CheckboxField label="‚ö†Ô∏è Pustole subcornee + neutrofili" checked={data.infiltrato_neutrofili_pustole} onChange={(v) => updateField('infiltrato_neutrofili_pustole', v)} variant="danger" />
                        </div>
                    </div>
                    <SelectField label="Edema dermico" value={data.edema_dermico} onChange={(v) => updateField('edema_dermico', v)} options={[{value:'assente',label:'Assente'},{value:'lieve',label:'Lieve'},{value:'moderato',label:'Moderato'},{value:'marcato',label:'Marcato'}]} />
                    
                    <div className="p-4 bg-purple-50 border-2 border-purple-200 rounded-lg">
                        <h3 className="font-bold text-purple-900 mb-3">üîç Clues Pattern Specifici</h3>
                        <div className="space-y-3">
                            <CheckboxField label="Paracheratosi 'a spalla' (shoulder) sugli infundiboli ‚Üí Seborroica" checked={data.paracheratosi_a_spalla} onChange={(v) => updateField('paracheratosi_a_spalla', v)} variant="warning" />
                            <CheckboxField label="Croste squamo-crostose perifollicolari ‚Üí Seborroica" checked={data.croste_perifollicolari} onChange={(v) => updateField('croste_perifollicolari', v)} variant="warning" />
                            <CheckboxField label="Ballooning cheratinociti (degenerazione balloniforme) ‚Üí Irritativa" checked={data.ballooning_cheratinociti} onChange={(v) => updateField('ballooning_cheratinociti', v)} variant="warning" />
                            <CheckboxField label="Croste sierose superficiali ‚Üí Nummulare/Eczema" checked={data.croste_sierose} onChange={(v) => updateField('croste_sierose', v)} variant="warning" />
                        </div>
                    </div>
                    
                    <div className="p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                        <h3 className="font-bold text-blue-900 mb-3">üìã Contesto Clinico</h3>
                        <div className="space-y-3">
                            <CheckboxField label="Storia farmaci recente" checked={data.storia_farmaci} onChange={(v) => updateField('storia_farmaci', v)} />
                            <CheckboxField label="Storia puntura insetto / artropodi" checked={data.storia_puntura_insetto} onChange={(v) => updateField('storia_puntura_insetto', v)} />
                        </div>
                    </div>
                    <div><label className="block font-semibold mb-2">Sede anatomica</label><input type="text" value={data.sede_anatomica} onChange={(e) => updateField('sede_anatomica', e.target.value)} placeholder="es. avambraccio sinistro" /></div>
                    <div><label className="block font-semibold mb-2">Note cliniche</label><textarea value={data.note_cliniche} onChange={(e) => updateField('note_cliniche', e.target.value)} placeholder="Contesto, durata, terapie..." className="h-24" /></div>
                </div>
                <NavigationButtons onBack={onBack} onNext={onGenerate} nextLabel="‚úì Genera Diagnosi" />
            </div>
        ));

        const DiagnosisCard = memo(({ diagnosis, index, isLymphoma, isEosinophilic }) => (
            <div className={`border-2 rounded-lg p-5 ${isLymphoma ? 'border-red-500 bg-red-50' : isEosinophilic ? 'border-orange-500 bg-orange-50' : index === 0 ? 'border-green-500 bg-green-50' : 'border-slate-200'}`}>
                <div className="flex justify-between items-start mb-3">
                    <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                            <h3 className="text-xl font-bold">{diagnosis.nome}</h3>
                            {isLymphoma && <span className="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">LINFOMA</span>}
                            {isEosinophilic && <span className="px-2 py-1 bg-orange-600 text-white text-xs font-bold rounded">EOSINOFILO</span>}
                        </div>
                        <p className="text-sm text-slate-600">{diagnosis.categoria}</p>
                    </div>
                    <div className="text-3xl font-bold text-blue-600 ml-4">{diagnosis.percentuale}%</div>
                </div>
                <p className="text-sm mb-3 bg-white rounded p-3">{diagnosis.note}</p>
                {diagnosis.colorazioni && diagnosis.colorazioni.length > 0 && (
                    <div className={`rounded p-3 mb-2 ${isLymphoma ? 'bg-red-100' : isEosinophilic ? 'bg-orange-100' : 'bg-amber-50'}`}>
                        <p className="text-sm font-semibold mb-1">üî¨ {isLymphoma ? 'IHC OBBLIGATORIA' : 'Colorazioni'}:</p>
                        <ul className="text-sm space-y-1">{diagnosis.colorazioni.map((c, i) => <li key={i}>‚Ä¢ {c}</li>)}</ul>
                    </div>
                )}
                {diagnosis.workup_molecolare && <div className="bg-purple-50 rounded p-3 mb-3"><p className="text-sm"><strong>üß¨ Workup:</strong> {diagnosis.workup_molecolare}</p></div>}
                <BibliographySection bibliografia={diagnosis.bibliografia} />
            </div>
        ));

        const ResultsView = memo(({ diagnoses, activeFlags, onModify, onExport }) => {
            const hasLymphoma = useMemo(() => diagnoses.some(d => d.categoria.includes('Linfoma')), [diagnoses]);
            const hasEosinophilic = useMemo(() => diagnoses.some(d => d.categoria === 'Eosinofilo'), [diagnoses]);
            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-2xl font-bold">üìã Diagnosi Differenziale</h2>
                        <div className="flex gap-2">
                            <button onClick={onExport} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">üíæ Esporta</button>
                            <button onClick={onModify} className="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 text-sm font-semibold">‚Üê Modifica</button>
                        </div>
                    </div>
                    {diagnoses.length === 0 && <div className="p-6 bg-amber-50 border-2 border-amber-200 rounded-lg text-center"><p className="font-semibold text-amber-900">‚ö†Ô∏è Nessuna diagnosi compatibile</p></div>}
                    {hasLymphoma && <div className="mb-6 p-4 bg-red-50 border-2 border-red-500 rounded-lg"><h3 className="text-lg font-bold text-red-900 mb-2">‚ö†Ô∏è SOSPETTO LINFOMA</h3><p className="text-sm text-red-800">IHC: CD3, CD4, CD8, CD7, CD30, Ki67 | PCR: TCR</p></div>}
                    {hasEosinophilic && <div className="mb-6 p-4 bg-orange-50 border-2 border-orange-500 rounded-lg"><h3 className="text-lg font-bold text-orange-900 mb-2">üî∂ PATTERN EOSINOFILO</h3><p className="text-sm text-orange-800">Correlazione clinica fondamentale: farmaci? punture? recidive? Flame figures = Wells.</p></div>}
                    {activeFlags.length > 0 && <div className="mb-6 p-4 bg-amber-50 border-2 border-amber-500 rounded-lg"><h3 className="text-lg font-bold text-amber-900 mb-2">üö© RED FLAGS</h3><div className="text-sm text-amber-800 space-y-1">{activeFlags.map((rf, i) => <p key={i}>‚Ä¢ <strong>{rf.diagnosi}</strong></p>)}</div></div>}
                    <div className="space-y-4">{diagnoses.map((d, i) => <DiagnosisCard key={d.key} diagnosis={d} index={i} isLymphoma={d.categoria.includes('Linfoma')} isEosinophilic={d.categoria === 'Eosinofilo'} />)}</div>
                    <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg"><p className="text-sm text-blue-900"><strong>üí° Nota:</strong> Diagnosi pattern-based. Correlazione clinico-patologica sempre necessaria.</p></div>
                </div>
            );
        });

        const DermPathDiagnostic = () => {
            const { step, nextStep, prevStep, reset: resetStep } = useMultiStepForm(1);
            const { data, updateField, reset: resetData } = useDiagnosticData();
            const [showResults, setShowResults] = useState(false);
            const [results, setResults] = useState({ diagnoses: [], activeFlags: [] });

            const handleReset = useCallback(() => { if (confirm('Resettare tutti i dati?')) { resetData(); resetStep(); setShowResults(false); setResults({ diagnoses: [], activeFlags: [] }); } }, [resetData, resetStep]);
            const handleCalculate = useCallback(() => { setResults(DiagnosticEngine.calculate(data)); setShowResults(true); }, [data]);
            const handleExport = useCallback(() => {
                const content = `REFERTO DERMATOPATOLOGICO\nData: ${new Date().toLocaleDateString('it-IT')}\nPattern: ${data.pattern_primario}\n\nDIAGNOSI:\n${results.diagnoses.map((d,i) => `${i+1}. ${d.nome} (${d.percentuale}%)\n   ${d.note}`).join('\n\n')}`;
                const blob = new Blob([content], { type: 'text/plain' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `referto_${Date.now()}.txt`; a.click();
            }, [data, results]);

            const renderStep = useMemo(() => {
                switch(step) {
                    case 1: return <PatternStep data={data} updateField={updateField} onNext={nextStep} />;
                    case 2: return <EpidermalStep data={data} updateField={updateField} onBack={prevStep} onNext={nextStep} />;
                    case 3: return <InfiltrateStep data={data} updateField={updateField} onBack={prevStep} onNext={nextStep} />;
                    case 4: return <CompletionStep data={data} updateField={updateField} onBack={prevStep} onGenerate={handleCalculate} />;
                    default: return null;
                }
            }, [step, data, updateField, nextStep, prevStep, handleCalculate]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-4xl">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <div><h1 className="text-3xl font-bold text-slate-800">üî¨ DermPath v1.6</h1><p className="text-slate-600 mt-1">Pattern-based Diagnostic Tool</p></div>
                                <button onClick={handleReset} className="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-semibold">üîÑ Reset</button>
                            </div>
                        </div>
                        {!showResults && <StepIndicator currentStep={step} />}
                        {!showResults ? <div className="bg-white rounded-xl shadow-lg p-6">{renderStep}</div> : <ResultsView diagnoses={results.diagnoses} activeFlags={results.activeFlags} onModify={() => setShowResults(false)} onExport={handleExport} />}
                        <div className="mt-6 text-center text-sm text-slate-600"><p>DermPath v1.6 - Eosinofile + Seborroica + Irritativa + SID + Nummulare + Virale</p></div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DermPathDiagnostic />, document.getElementById('root'));
    </script>
</body>
</html>
