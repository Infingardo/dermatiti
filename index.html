<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DermPath v1.9 - Complete Update</title>
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        html{font-family:system-ui,-apple-system,sans-serif;line-height:1.5}
        .min-h-screen{min-height:100vh}.max-w-4xl{max-width:56rem;margin:0 auto}
        .flex{display:flex}.flex-1{flex:1}.grid{display:grid}
        .grid-cols-2{grid-template-columns:repeat(2,1fr)}
        .items-center{align-items:center}.items-start{align-items:flex-start}
        .justify-between{justify-content:space-between}.block{display:block}
        .p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}
        .py-3{padding:.75rem 0}.px-4{padding:0 1rem}
        .mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}
        .mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}
        .ml-4{margin-left:1rem}.mr-3{margin-right:.75rem}.gap-2{gap:.5rem}.gap-4{gap:1rem}
        .space-y-2>*+*{margin-top:.5rem}.space-y-3>*+*{margin-top:.75rem}.space-y-4>*+*{margin-top:1rem}
        .w-full{width:100%}.w-10{width:2.5rem}.h-1{height:.25rem}.h-10{height:2.5rem}
        .text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}
        .font-bold{font-weight:700}.font-semibold{font-weight:600}.font-medium{font-weight:500}.italic{font-style:italic}.text-center{text-align:center}
        .text-white{color:#fff}.text-slate-500{color:#64748b}.text-slate-600{color:#475569}.text-slate-700{color:#334155}.text-slate-800{color:#1e293b}
        .text-blue-600{color:#2563eb}.text-blue-800{color:#1e40af}.text-blue-900{color:#1e3a8a}
        .text-red-800{color:#991b1b}.text-red-900{color:#7f1d1d}.text-amber-800{color:#92400e}.text-amber-900{color:#78350f}
        .text-orange-800{color:#9a3412}.text-green-700{color:#15803d}.text-green-800{color:#166534}
        .text-indigo-800{color:#3730a3}.text-indigo-900{color:#312e81}.text-violet-800{color:#5b21b6}
        .text-teal-800{color:#115e59}.text-teal-900{color:#134e4a}.text-pink-800{color:#9d174d}
        .bg-white{background:#fff}.bg-slate-50{background:#f8fafc}.bg-slate-100{background:#f1f5f9}.bg-slate-200{background:#e2e8f0}.bg-slate-300{background:#cbd5e1}
        .bg-blue-50{background:#eff6ff}.bg-blue-600{background:#2563eb}.bg-blue-700{background:#1d4ed8}
        .bg-green-50{background:#f0fdf4}.bg-green-600{background:#16a34a}.bg-green-700{background:#15803d}
        .bg-red-50{background:#fef2f2}.bg-red-100{background:#fee2e2}.bg-amber-50{background:#fffbeb}.bg-amber-100{background:#fef3c7}
        .bg-purple-50{background:#faf5ff}.bg-orange-50{background:#fff7ed}.bg-orange-100{background:#ffedd5}
        .bg-indigo-50{background:#eef2ff}.bg-indigo-100{background:#e0e7ff}.bg-violet-50{background:#f5f3ff}
        .bg-teal-50{background:#f0fdfa}.bg-teal-100{background:#ccfbf1}.bg-pink-50{background:#fdf2f8}
        .border{border-width:1px}.border-2{border-width:2px}
        .border-slate-200{border-color:#e2e8f0}.border-slate-300{border-color:#cbd5e1}
        .border-blue-200{border-color:#bfdbfe}.border-blue-300{border-color:#93c5fd}.border-blue-600{border-color:#2563eb}
        .border-red-200{border-color:#fecaca}.border-red-300{border-color:#fca5a5}.border-red-500{border-color:#ef4444}
        .border-amber-200{border-color:#fde68a}.border-amber-500{border-color:#f59e0b}
        .border-orange-200{border-color:#fed7aa}.border-orange-500{border-color:#f97316}
        .border-purple-200{border-color:#e9d5ff}.border-purple-300{border-color:#d8b4fe}
        .border-indigo-200{border-color:#c7d2fe}.border-indigo-300{border-color:#a5b4fc}.border-indigo-500{border-color:#6366f1}
        .border-violet-300{border-color:#c4b5fd}.border-teal-300{border-color:#5eead4}.border-teal-500{border-color:#14b8a6}
        .border-pink-300{border-color:#f9a8d4}
        .rounded{border-radius:.25rem}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.rounded-full{border-radius:9999px}
        .shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
        .overflow-x-auto{overflow-x:auto}.cursor-pointer{cursor:pointer}.border-dashed{border-style:dashed}
        select,input[type="text"],textarea{width:100%;padding:.75rem;border:2px solid #e2e8f0;border-radius:.5rem;font-size:1rem}
        select:focus,input:focus,textarea:focus{outline:none;border-color:#2563eb}
        table{width:100%;border-collapse:collapse}th,td{padding:.5rem;text-align:left;border-bottom:1px solid #e2e8f0}
    </style>
</head>
<body>
    <div id="root"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
const{useState,useMemo,useCallback,memo}=React;
const SC={MAJOR:3,MINOR:1,SOFT:0.9,RED_PENALTY:25,MIN_EXCL:5,THRESH:50};

const INIT={
    pattern_primario:'',spongiosi:'',esocitosi:'',acantosi:'',paracheratosi:'',ipergranulosi:'',ipogranulosi:'',
    vacuolizzazione_basale:'',necrosi_keratinociti:'',infiltrato_distribuzione:'',infiltrato_densita:'',
    eosinofili:'',neutrofili:'',linfociti_atipici:'',epidermotropismo:'',alone_chiaro:false,cellule_cerebriformi:false,
    cd30_positivi:false,microascessi_munro:false,vasculite:'',eritrociti_extravasati:'',sede_anatomica:'',note_cliniche:'',
    edema_dermico:'',palisading_necrosi_mucina:false,microvescicole:false,corpi_civatte:false,
    acantolisi:false,bolle_intraepidermiche:false,bolle_subepidermiche:false,infiltrato_neutrofili_pustole:false,
    flame_figures:false,infiltrato_wedge_shaped:false,eosinofili_perivascolari_profondi:false,degranulazione_eosinofila:false,
    necrosi_epidermica_focale:false,storia_farmaci:false,storia_puntura_insetto:false,
    fibrosi_dermica:false,iperplasia_neurale:false,infiltrato_follicolare:false,spongiosi_follicolare:false,pustole_follicolari:false,
    neutrofili_in_paracheratosi:false,assottigliamento_soprapapillare:false,granuli_cheratoialina:'',capillari_dilatati_papille:false,
    saw_toothing:false,ipergranulosi_cuneo:false,granulomi_miescher:false,plugging_follicolare:false,
    mucina_dermica:'',plasmacellule:'',infiltrato_perianessiale_profondo:false,necrosi_adipociti:false,emofagocitosi:false,
    panniculite_tipo:'',panniculite_vasculite:false,
    // v1.9 nuovi campi
    fase_lesione:'',paracheratosi_mounds:false,infiltrato_manicotto:false,necrosi_cheratino_superficiale:false,
    ghost_cells:false,calcificazione_basofila:false,trombi_fibrina:false,leucocitoclasia:false,depositi_emosiderina:false,
    necrobiosi_sandwich:false,fibrina_centrale:false,mastociti_aggregati:false,cd117_pos:false,cd25_aberrante:false,
    mxa_positivo:false,cd123_clusters:false,follicoli_germinativi:false,necrosi_ialina_grasso:false
};

const PATTERNS=[
    {value:'spongotico',label:'Spongotico',desc:'Edema intercellulare'},
    {value:'psoriasiforme',label:'Psoriasiforme',desc:'Allungamento rete ridges'},
    {value:'interfaccia_lichenoide',label:'Interfaccia Lichenoide',desc:'Infiltrato banda densa'},
    {value:'interfaccia_vacuolare',label:'Interfaccia Vacuolare',desc:'Vacuoli basali, infiltrato sparso'},
    {value:'perivascolare',label:'Perivascolare',desc:'Infiltrato attorno vasi'},
    {value:'perivascolare_eosinofilo',label:'Perivascolare Eosinofilo',desc:'Eosinofili perivascolari'},
    {value:'vasculitico',label:'Vasculitico',desc:'Necrosi fibrinoide'},
    {value:'vasculopatico',label:'Vasculopatico',desc:'Trombi senza infiammazione'},
    {value:'granulomatoso',label:'Granulomatoso',desc:'Granulomi dermici'},
    {value:'granulomatoso_palizzata',label:'Granulomatoso Palizzata',desc:'Necrobiosi + istiociti'},
    {value:'subcorneo',label:'Subcorneo',desc:'Pustole sottocornee'},
    {value:'intraepidermico',label:'Intraepidermico',desc:'Acantolisi'},
    {value:'subepidermico_bolloso',label:'Subepidermico Bolloso',desc:'Bolle subepidermiche'},
    {value:'interstiziale_eosinofilo',label:'Interstiziale Eosinofilo',desc:'Eosinofili diffusi'},
    {value:'panniculitico',label:'Panniculitico',desc:'Infiltrato sottocute'},
    {value:'mastocitario',label:'Mastocitario',desc:'Infiltrato mastociti'}
];

const RED_FLAGS=[
    {flag:"microascessi_munro",diagnosi:"Psoriasi",escludi:["dermatite_allergica_contatto","dermatite_atopica_acuta"]},
    {flag:"corpi_civatte",diagnosi:"Lichen planus",escludi:["psoriasi_vulgaris"]},
    {flag:"eosinofili_marcati_edema",diagnosi:"Dermatite da contatto",escludi:["psoriasi_vulgaris"]},
    {flag:"palisading_necrosi_mucina",diagnosi:"Granuloma anulare",escludi:["dermatite_allergica_contatto"]},
    {flag:"epidermotropismo_alone",diagnosi:"Linfoma cutaneo",escludi:["dermatite_allergica_contatto"]},
    {flag:"acantolisi_bolloso",diagnosi:"Pemfigo volgare",escludi:["pemfigoide_bolloso"]},
    {flag:"bolle_subepidermiche_eosinofili",diagnosi:"Pemfigoide bolloso",escludi:["pemfigo_volgare"]},
    {flag:"flame_figures_eosinofili",diagnosi:"Sindrome di Wells",escludi:["reazione_puntura_insetto"]},
    {flag:"wedge_eosinofili_profondo",diagnosi:"Reazione da puntura",escludi:["sindrome_wells"]},
    {flag:"neutrofili_paracheratosi_psoriasi",diagnosi:"Psoriasi (Segno √ë)",escludi:["dermatite_allergica_contatto"]},
    {flag:"granuli_grossolani_lsc",diagnosi:"LSC/Eczema cronico",escludi:["psoriasi_vulgaris"]},
    {flag:"saw_toothing_civatte",diagnosi:"Lichen planus",escludi:["lupus_cutaneo_discoide"]},
    {flag:"plasmacellule_psoriasiforme",diagnosi:"SIFILIDE SECONDARIA!",escludi:["psoriasi_vulgaris"]},
    {flag:"granulomi_miescher_en",diagnosi:"Eritema nodoso",escludi:["lupus_panniculitis"]},
    {flag:"emofagocitosi_lobulare",diagnosi:"SPTCL (linfoma)",escludi:["eritema_nodoso","lupus_panniculitis"]},
    // v1.9 nuove red flags
    {flag:"ghost_cells_panniculite",diagnosi:"Panniculite PANCREATICA!",escludi:["lupus_panniculitis","eritema_nodoso"]},
    {flag:"trombi_no_lcv",diagnosi:"Vasculopatia (non vasculite)",escludi:["vasculite_leucocitoclastica"]},
    {flag:"mxa_cd123_lupus",diagnosi:"Lupus/Connettivite",escludi:["micosi_fungoide_early"]},
    {flag:"mastociti_cd25",diagnosi:"Mastocitosi sistemica",escludi:[]},
    {flag:"paracheratosi_mounds_manicotto",diagnosi:"Pitiriasi rosea",escludi:["sifilide_secondaria"]}
];

const IHC_PERF={
    PCR_TCR:{test:"PCR TCR dual-site",ind:"MF vs dermatite",sens:"82.6",spec:"95.7"},
    DIF_lupus:{test:"DIF Lupus Band",ind:"Lupus cutaneo",sens:"71-84",spec:">90"},
    DIF_LP:{test:"DIF IgM fibrillar",ind:"Lichen planus",sens:"78.5",spec:">90"},
    CD123:{test:"CD123 ‚â•10 cellule",ind:"Lupus vs LPP",sens:"50",spec:"93"},
    BP180:{test:"ELISA BP180",ind:"Pemfigoide",sens:"82-90",spec:"94"},
    Treponema:{test:"IHC Treponema",ind:"Sifilide",sens:"60-70",spec:"100"},
    SPTCL:{test:"CD3+CD8+Œ≤F1+CD56-",ind:"SPTCL",sens:">95",spec:">95"},
    // v1.9 nuovi
    MxA:{test:"MxA (IFN type I)",ind:"Lupus/DM vs altri",sens:"85-95",spec:">90"},
    Ki67_pso:{test:"Ki-67 soprabasale",ind:"Psoriasi vs eczema",sens:"83",spec:"~70"},
    CD117:{test:"CD117 + Triptasi",ind:"Mastocitosi",sens:">95",spec:">95"},
    CD25_mast:{test:"CD25 aberrante",ind:"Mastocitosi sistemica",sens:"~90",spec:">95"}
};

const IHC_PSO_SPONG={
    titolo:"Pannello IHC: Psoriasi vs Spongotico",
    fonte:"Healthcare Bulletin 2025",
    marcatori:[
        {nome:"Ki-67",pso:"Soprabasale diffuso",spong:"Solo basale",note:"Forte discriminante"},
        {nome:"p53",pso:"Iperespresso",spong:"Basale/debole",note:"Combinare con Ki-67"},
        {nome:"CD34",pso:"Capillari densi tortuosi",spong:"Meno densi",note:"Angiogenesi"},
        {nome:"IL-36Œ≥",pso:"Forte epidermide sup",spong:"Assente/focale",note:"Alta specificit√† 2025"}
    ]
};

const DX={
    dermatite_allergica_contatto:{
        nome:"Dermatite allergica da contatto",cat:"Spongotico",
        major:{pattern_primario:"spongotico",spongiosi:["moderata","marcata"],esocitosi:"presente"},
        minor:{eosinofili:["presenti","abbondanti"],infiltrato_distribuzione:"perivascolare_superficiale"},
        note:"Pattern ipersensibilit√† IV. Eosinofili dermici frequenti.",
        color:["PAS escludere dermatofiti"],ihc:null,
        bib:{autori:"Usatine RP",titolo:"Contact Dermatitis",riv:"Am Fam Physician",anno:2010,pmid:"20672788"}
    },
    dermatite_atopica_acuta:{
        nome:"Dermatite atopica (acuta)",cat:"Spongotico",
        major:{pattern_primario:"spongotico",spongiosi:["moderata","marcata"],esocitosi:"presente"},
        minor:{eosinofili:["presenti","abbondanti"],paracheratosi:"focale"},
        note:"CLUE vs MF: spongiosi PROPORZIONATA all'esocitosi. Spongiosi follicolare nei fototipi scuri.",
        color:["PAS"],ihc:null,
        bib:{autori:"Weidinger S",titolo:"Atopic Dermatitis",riv:"Lancet",anno:2016,pmid:"26377142"}
    },
    dermatite_irritativa:{
        nome:"Dermatite irritativa (ICD)",cat:"Spongotico",
        major:{pattern_primario:"spongotico",spongiosi:["lieve","moderata"],necrosi_cheratino_superficiale:true},
        minor:{neutrofili:["rari","presenti"],eosinofili:"assenti"},
        note:"vs ACD: NECROSI cheratinociti superficiali, NEUTROFILI precoci, MENO eosinofili. Ballooning.",
        color:["PAS"],ihc:null,
        bib:{autori:"Brasch J",titolo:"ICD pathophysiology",riv:"Contact Dermatitis",anno:2014,pmid:"24372629"}
    },
    pitiriasi_rosea:{
        nome:"Pitiriasi rosea",cat:"Spongotico",
        major:{pattern_primario:"spongotico",spongiosi:["lieve","moderata"],paracheratosi_mounds:true},
        minor:{infiltrato_manicotto:true,eritrociti_extravasati:"presenti"},
        note:"Paracheratosi 'A TUMULI' (mounds). Infiltrato 'A MANICOTTO' perivascolare. NO plasmacellule (vs sifilide).",
        color:["Sierologia lue obbligatoria"],ihc:null,
        bib:{autori:"Drago F",titolo:"Pityriasis rosea",riv:"JAAD",anno:2016,pmid:"27212086"}
    },
    psoriasi_vulgaris:{
        nome:"Psoriasi vulgaris",cat:"Psoriasiforme",
        major:{pattern_primario:"psoriasiforme",acantosi:"marcata",paracheratosi:["moderata","marcata"],ipogranulosi:"si"},
        minor:{neutrofili:["presenti","abbondanti"],microascessi_munro:true,neutrofili_in_paracheratosi:true,assottigliamento_soprapapillare:true,granuli_cheratoialina:"diminuiti",capillari_dilatati_papille:true},
        note:"Creste REGOLARI. Granuloso ASSENTE. SEGNO √ë. NO plasmacellule!",
        color:["PAS escludere tinea"],ihc:null,
        bib:{autori:"Armstrong AW",titolo:"Psoriasis",riv:"JAMA",anno:2020,pmid:"32427307"}
    },
    sifilide_secondaria:{
        nome:"Sifilide secondaria",cat:"Psoriasiforme/Lichenoide",
        major:{pattern_primario:["psoriasiforme","interfaccia_lichenoide"],plasmacellule:["presenti","abbondanti"]},
        minor:{vacuolizzazione_basale:"presente",infiltrato_distribuzione:["perivascolare_superficiale","perivascolare_profondo"]},
        note:"‚ö†Ô∏è GRANDE SIMULATRICE! CLUE: PLASMACELLULE (assenti in psoriasi). Endotelio tumefatto.",
        color:["IHC anti-Treponema (sens 60-70%, spec 100%)","Warthin-Starry"],ihc:"Treponema",
        bib:{autori:"Carlson JA",titolo:"Secondary syphilis spectrum",riv:"Am J Dermatopathol",anno:2011,pmid:"21317614"}
    },
    lichen_planus:{
        nome:"Lichen planus",cat:"Interfaccia/Lichenoide",
        major:{pattern_primario:"interfaccia_lichenoide",infiltrato_distribuzione:"banda_lichenoide",vacuolizzazione_basale:"presente"},
        minor:{necrosi_keratinociti:"presente",ipergranulosi:"si",saw_toothing:true,ipergranulosi_cuneo:true,corpi_civatte:true},
        note:"Banda DENSA. Civatte. SAW-TOOTHING. Ipergranulosi CUNEO. NO paracheratosi. DIF: IgM fibrillar (sens 78%).",
        color:["IF diretta"],ihc:"DIF_LP",
        bib:{autori:"Gupta S",titolo:"Lichen Planus",riv:"Indian J Dermatol",anno:2015,pmid:"26120146"}
    },
    lupus_cutaneo_discoide:{
        nome:"Lupus eritematoso discoide",cat:"Interfaccia/Vacuolare",
        major:{pattern_primario:"interfaccia_vacuolare",vacuolizzazione_basale:["presente","marcata"],plugging_follicolare:true},
        minor:{mucina_dermica:["focale","abbondante"],infiltrato_perianessiale_profondo:true,plasmacellule:"presenti",mxa_positivo:true,cd123_clusters:true},
        note:"PLUGGING FOLLICOLARE. Infiltrato sup+PROFONDO. MUCINA. MxA+ cheratinociti. CD123 CLUSTERS (vs sparso in MF).",
        color:["IF diretta","Alcian blue","CD123","MxA"],ihc:"DIF_lupus",
        bib:{autori:"Crowson AN",titolo:"Lupus cutaneous pathology",riv:"J Cutan Pathol",anno:2001,pmid:"11168761"}
    },
    lupus_cutaneo_subacuto:{
        nome:"Lupus eritematoso subacuto",cat:"Interfaccia/Vacuolare",
        major:{pattern_primario:"interfaccia_vacuolare",vacuolizzazione_basale:"presente"},
        minor:{mucina_dermica:["focale","abbondante"],infiltrato_distribuzione:"perivascolare_superficiale",mxa_positivo:true},
        note:"Pi√π superficiale del discoide. Meno plugging. Foto-distribuito. Anti-Ro/SSA. MxA+.",
        color:["IF diretta","Alcian blue","MxA"],ihc:"MxA",
        bib:{autori:"Sontheimer RD",titolo:"SCLE",riv:"Clin Dermatol",anno:1985,pmid:"3833325"}
    },
    dermatomiosite:{
        nome:"Dermatomiosite",cat:"Interfaccia/Vacuolare",
        major:{pattern_primario:"interfaccia_vacuolare",vacuolizzazione_basale:"presente",mucina_dermica:["focale","abbondante"]},
        minor:{mxa_positivo:true,edema_dermico:["moderato","marcato"]},
        note:"Vacuolare + MUCINA dermica abbondante. MxA+ (firma IFN tipo I). Atrofia epidermica possibile.",
        color:["Alcian blue","MxA"],ihc:"MxA",
        bib:{autori:"Casciola-Rosen L",titolo:"Dermatomyositis",riv:"Curr Opin Rheumatol",anno:2015,pmid:"25415528"}
    },
    lichen_simplex_chronicus:{
        nome:"Lichen simplex chronicus",cat:"Psoriasiforme/Spongotico",
        major:{pattern_primario:["psoriasiforme","spongotico"],acantosi:["moderata","marcata"],ipergranulosi:"si"},
        minor:{granuli_cheratoialina:"grossolani",fibrosi_dermica:true},
        note:"IPERGRANULOSI. Granuli GROSSOLANI (vs diminuiti psoriasi). Fibrosi VERTICALE.",
        color:[],ihc:null,
        bib:{autori:"Lotti T",titolo:"LSC and prurigo",riv:"Dermatol Ther",anno:2008,pmid:"18715294"}
    },
    eritema_multiforme:{
        nome:"Eritema multiforme",cat:"Interfaccia",
        major:{pattern_primario:"interfaccia_lichenoide",necrosi_keratinociti:"marcata",vacuolizzazione_basale:"presente"},
        minor:{eosinofili:"presenti"},
        note:"Necrosi cheratinocitaria DIFFUSA. Post-HSV. Infiltrato spesso SCARSO.",
        color:[],ihc:null,
        bib:{autori:"Sokumbi O",titolo:"EM features",riv:"J Am Acad Dermatol",anno:2012,pmid:"22177632"}
    },
    vasculite_leucocitoclastica:{
        nome:"Vasculite leucocitoclastica",cat:"Vasculitico",
        major:{pattern_primario:["perivascolare","vasculitico"],vasculite:"si",neutrofili:"abbondanti",leucocitoclasia:true},
        minor:{eritrociti_extravasati:["presenti","abbondanti"]},
        note:"NECROSI FIBRINOIDE parete. LEUCOCITOCLASIA (polvere nucleare). Porpora palpabile.",
        color:["IF diretta per IgA"],ihc:null,
        bib:{autori:"Sunderk√∂tter CH",titolo:"Cutaneous Vasculitis",riv:"Arthritis Rheumatol",anno:2018,pmid:"29266783"}
    },
    vasculopatia_livedoide:{
        nome:"Vasculopatia livedoide",cat:"Vasculopatico",
        major:{pattern_primario:"vasculopatico",trombi_fibrina:true,leucocitoclasia:false},
        minor:{depositi_emosiderina:true},
        note:"‚ö†Ô∏è NON √à VASCULITE! Trombi fibrina intraluminali, ispessimento ialino pareti. NO leucocitoclasia. Porpora reticolata.",
        color:["Perls (emosiderina)","Fibrina"],ihc:null,
        bib:{autori:"Criado PR",titolo:"Livedoid vasculopathy",riv:"An Bras Dermatol",anno:2011,pmid:"21603806"}
    },
    reazione_puntura_insetto:{
        nome:"Reazione da puntura",cat:"Eosinofilo",
        major:{pattern_primario:["perivascolare_eosinofilo","interstiziale_eosinofilo"],eosinofili:"abbondanti"},
        minor:{edema_dermico:["moderato","marcato"],infiltrato_wedge_shaped:true,necrosi_epidermica_focale:true},
        note:"Pattern WEDGE-SHAPED. Possibile necrosi focale (punto inoculo).",
        color:["Giemsa se sospetto leishmaniosi"],ihc:null,
        bib:{autori:"Miteva M",titolo:"Arthropod Bite",riv:"Dermatol Ther",anno:2012,pmid:"22741932"}
    },
    sindrome_wells:{
        nome:"Sindrome di Wells",cat:"Eosinofilo",
        major:{pattern_primario:["interstiziale_eosinofilo","perivascolare_eosinofilo"],eosinofili:"abbondanti",flame_figures:true},
        minor:{edema_dermico:["moderato","marcato"],degranulazione_eosinofila:true},
        note:"‚ö†Ô∏è FLAME FIGURES patognomoniche.",
        color:["H&E","Congo rosso"],ihc:null,
        bib:{autori:"R√§√üler F",titolo:"Eosinophilic cellulitis",riv:"JEADV",anno:2016,pmid:"27291961"}
    },
    drug_reaction_eosinofila:{
        nome:"Drug reaction eosinofila",cat:"Eosinofilo",
        major:{pattern_primario:["perivascolare_eosinofilo","interfaccia_vacuolare"],eosinofili:["presenti","abbondanti"],eosinofili_perivascolari_profondi:true},
        minor:{vacuolizzazione_basale:"presente",storia_farmaci:true},
        note:"‚ö†Ô∏è Eosinofili sup + PROFONDI = drug. Correlazione farmaci!",
        color:[],ihc:null,
        bib:{autori:"Mockenhaupt M",titolo:"Drug reactions",riv:"Allergol Select",anno:2017,pmid:"30402608"}
    },
    orticaria:{
        nome:"Orticaria",cat:"Eosinofilo",
        major:{pattern_primario:["perivascolare_eosinofilo","perivascolare"],edema_dermico:["moderato","marcato"]},
        minor:{eosinofili:["presenti","abbondanti"],spongiosi:"lieve"},
        note:"Edema marcato, SCARSO infiltrato. Pattern 'cell-poor'.",
        color:[],ihc:null,
        bib:{autori:"Zuberbier T",titolo:"Urticaria guideline",riv:"Allergy",anno:2022,pmid:"34536239"}
    },
    prurigo_nodularis:{
        nome:"Prurigo nodularis",cat:"Eosinofilo",
        major:{pattern_primario:["perivascolare","perivascolare_eosinofilo"],acantosi:["moderata","marcata"],ipergranulosi:"si"},
        minor:{fibrosi_dermica:true,iperplasia_neurale:true,granuli_cheratoialina:"grossolani"},
        note:"Ipergranulosi. Fibrosi verticale. Iperplasia neurale (S100+).",
        color:["S100","PGP9.5"],ihc:null,
        bib:{autori:"Williams KA",titolo:"Prurigo nodularis",riv:"JAAD",anno:2020,pmid:"32461078"}
    },
    follicolite_eosinofila:{
        nome:"Follicolite eosinofila",cat:"Eosinofilo",
        major:{pattern_primario:["perivascolare_eosinofilo","interstiziale_eosinofilo"],eosinofili:"abbondanti",infiltrato_follicolare:true},
        minor:{spongiosi_follicolare:true,pustole_follicolari:true},
        note:"‚ö†Ô∏è Eosinofili CENTRATI SUI FOLLICOLI. HIV: CD4<300.",
        color:["PAS/Grocott","Gram"],ihc:null,
        bib:{autori:"Nervi SJ",titolo:"Eosinophilic folliculitis",riv:"JAAD",anno:2006,pmid:"16844513"}
    },
    micosi_fungoide_early:{
        nome:"Micosi fungoide (early)",cat:"Linfoma cutaneo T",
        major:{pattern_primario:["spongotico","interfaccia_lichenoide"],linfociti_atipici:"presenti"},
        minor:{epidermotropismo:"presente",alone_chiaro:true},
        note:"‚ö†Ô∏è LINFOMA! Epidermotropismo SENZA spongiosi. Alone chiaro. PCR TCR: sens 82.6%, spec 95.7%.",
        color:["CD3","CD4","CD8","CD7 loss","TOX","PD-1"],ihc:"PCR_TCR",
        bib:{autori:"Willemze R",titolo:"WHO-EORTC lymphomas",riv:"Blood",anno:2019,pmid:"30635287"}
    },
    granuloma_anulare:{
        nome:"Granuloma anulare",cat:"Granulomatoso",
        major:{pattern_primario:["granulomatoso","granulomatoso_palizzata"],palisading_necrosi_mucina:true},
        minor:{mucina_dermica:["focale","abbondante"]},
        note:"Palisading + MUCINA centrale (Alcian blue+). No necrosi fibrinoide. Rari eosinofili.",
        color:["PAS","Alcian blue"],ihc:null,
        bib:{autori:"Piette EW",titolo:"GA",riv:"JAAD",anno:2016,pmid:"27021234"}
    },
    necrobiosi_lipoidica:{
        nome:"Necrobiosi lipoidica",cat:"Granulomatoso Palizzata",
        major:{pattern_primario:["granulomatoso","granulomatoso_palizzata"],necrobiosi_sandwich:true},
        minor:{plasmacellule:"presenti",fibrosi_dermica:true},
        note:"Necrobiosi 'A SANDWICH' (strati infiammatori alternati a collagene ialinizzato). TUTTO SPESSORE derma. Plasmacellule.",
        color:["PAS","VVG elastiche"],ihc:null,
        bib:{autori:"Reid SD",titolo:"Necrobiosis lipoidica",riv:"Am J Clin Dermatol",anno:2013,pmid:"23329076"}
    },
    sarcoidosi_cutanea:{
        nome:"Sarcoidosi cutanea",cat:"Granulomatoso",
        major:{pattern_primario:"granulomatoso"},
        minor:{},
        note:"Granulomi 'NUDI'. NO necrosi caseosa. Polarizzazione NEGATIVA.",
        color:["ZN/Fite","PAS/GMS","Luce polarizzata"],ihc:null,
        bib:{autori:"Sanchez M",titolo:"Cutaneous sarcoidosis",riv:"Clin Chest Med",anno:2015,pmid:"26304139"}
    },
    pemfigo_volgare:{
        nome:"Pemfigo volgare",cat:"Bolloso Intraepidermico",
        major:{pattern_primario:"intraepidermico",acantolisi:true,bolle_intraepidermiche:true},
        minor:{},
        note:"‚ö†Ô∏è Acantolisi SOPRABASALE. Tombstoning. DIF: IgG rete (sens ~95%).",
        color:["IF: IgG/C3 intercellulari"],ihc:null,
        bib:{autori:"Joly P",titolo:"Pemphigus guidelines",riv:"JEADV",anno:2020,pmid:"32686180"}
    },
    pemfigoide_bolloso:{
        nome:"Pemfigoide bolloso",cat:"Bolloso Subepidermico",
        major:{pattern_primario:"subepidermico_bolloso",bolle_subepidermiche:true},
        minor:{eosinofili:["presenti","abbondanti"]},
        note:"‚ö†Ô∏è Bolle subepidermiche + EOSINOFILI. DIF: IgG+C3 lineari (sens ~80%). ELISA BP180: sens 82-90%, spec 94%.",
        color:["IF: IgG+C3 lineari BMZ"],ihc:"BP180",
        bib:{autori:"Schmidt E",titolo:"Pemphigoid",riv:"J Invest Dermatol",anno:2016,pmid:"26763419"}
    },
    dermatite_erpetiforme:{
        nome:"Dermatite erpetiforme",cat:"Bolloso Subepidermico",
        major:{pattern_primario:"subepidermico_bolloso",bolle_subepidermiche:true,neutrofili:["presenti","abbondanti"]},
        minor:{},
        note:"Microascessi NEUTROFILI tips papillari. DIF: IgA GRANULARE (gold standard, sens ~90%, spec ~100%).",
        color:["IF: IgA granulare papille"],ihc:null,
        bib:{autori:"Caproni M",titolo:"DH guidelines",riv:"JEADV",anno:2009,pmid:"19470041"}
    },
    eritema_nodoso:{
        nome:"Eritema nodoso",cat:"Panniculite Settale",
        major:{pattern_primario:"panniculitico",panniculite_tipo:"settale"},
        minor:{granulomi_miescher:true,fibrosi_dermica:true,panniculite_vasculite:false},
        note:"SETTALE senza vasculite. GRANULOMI MIESCHER (rosetta) quasi patognomonici. Escludere cause.",
        color:["Workup sistemico"],ihc:null,
        bib:{autori:"Requena L",titolo:"Panniculitis I",riv:"JAAD",anno:2001,pmid:"11169025"}
    },
    lupus_panniculitis:{
        nome:"Lupus panniculitis",cat:"Panniculite Lobulare",
        major:{pattern_primario:"panniculitico",panniculite_tipo:"lobulare",follicoli_germinativi:true},
        minor:{mucina_dermica:["focale","abbondante"],plasmacellule:"presenti",vacuolizzazione_basale:"presente",necrosi_ialina_grasso:true},
        note:"LOBULARE linfocitaria. FOLLICOLI LINFOIDI con centri germinativi. MUCINA nel grasso. Necrosi ialina.",
        color:["IF diretta","Alcian blue"],ihc:"DIF_lupus",
        bib:{autori:"Massone C",titolo:"Lupus panniculitis",riv:"Dermatol Clin",anno:2008,pmid:"18346555"}
    },
    panniculite_pancreatica:{
        nome:"Panniculite pancreatica",cat:"Panniculite Lobulare",
        major:{pattern_primario:"panniculitico",panniculite_tipo:"lobulare",ghost_cells:true},
        minor:{calcificazione_basofila:true,neutrofili:"abbondanti"},
        note:"‚ö†Ô∏è GHOST CELLS patognomoniche (adipociti senza nucleo, pareti ispessite). Calcificazione basofila (saponificazione). ESCLUDERE CARCINOMA PANCREAS!",
        color:["Von Kossa (calcio)","Lipasi sierica"],ihc:null,
        bib:{autori:"Requena L",titolo:"Panniculitis II",riv:"JAAD",anno:2001,pmid:"11169026"}
    },
    sptcl:{
        nome:"SPTCL (Linfoma panniculitico)",cat:"Panniculite Lobulare / Linfoma",
        major:{pattern_primario:"panniculitico",panniculite_tipo:"lobulare",linfociti_atipici:["presenti","abbondanti"]},
        minor:{necrosi_adipociti:true,emofagocitosi:true},
        note:"‚ö†Ô∏è LINFOMA! Linfociti 'rimming' adipociti. EMOFAGOCITOSI. IHC: CD3+CD8+Œ≤F1+CD56- (Œ±Œ≤). PCR TCR clonale.",
        color:["CD3","CD8","CD4","Œ≤F1","CD56","Granzyme","CD68"],ihc:"SPTCL",
        bib:{autori:"Willemze R",titolo:"WHO-EORTC",riv:"Blood",anno:2019,pmid:"30635287"}
    },
    vasculite_nodulare:{
        nome:"Vasculite nodulare / Er. indurato",cat:"Panniculite Lobulare/Settale",
        major:{pattern_primario:"panniculitico",panniculite_vasculite:true},
        minor:{panniculite_tipo:"lobulare"},
        note:"Lobulo-SETTALE + VASCULITE necrotizzante. Associazione TB (Bazin). Necrosi caseosa possibile.",
        color:["ZN/Fite","PCR MTB"],ihc:null,
        bib:{autori:"Segura S",titolo:"Erythema induratum",riv:"Arch Dermatol",anno:2008,pmid:"18490591"}
    },
    mastocitosi_cutanea:{
        nome:"Mastocitosi cutanea",cat:"Mastocitario",
        major:{pattern_primario:"mastocitario",mastociti_aggregati:true,cd117_pos:true},
        minor:{cd25_aberrante:true},
        note:"Aggregati ‚â•15 mastociti. CD117+ (c-kit), TRIPTASI+. CD25/CD2 ABERRANTE = sospetto sistemico. Giemsa metacromasia.",
        color:["Giemsa/Toluidina blu","CD117","Triptasi","CD25"],ihc:"CD117",
        bib:{autori:"Valent P",titolo:"Mastocytosis WHO",riv:"Blood",anno:2017,pmid:"28053105"}
    }
};

const Engine={
    evalFlag(f,d){
        const chk={
            microascessi_munro:()=>d.microascessi_munro,
            corpi_civatte:()=>d.corpi_civatte,
            eosinofili_marcati_edema:()=>d.eosinofili==="abbondanti"&&d.edema_dermico==="marcato",
            palisading_necrosi_mucina:()=>d.palisading_necrosi_mucina,
            epidermotropismo_alone:()=>d.epidermotropismo==="presente"&&d.alone_chiaro,
            acantolisi_bolloso:()=>d.acantolisi&&d.bolle_intraepidermiche,
            bolle_subepidermiche_eosinofili:()=>d.bolle_subepidermiche&&["presenti","abbondanti"].includes(d.eosinofili),
            flame_figures_eosinofili:()=>d.flame_figures&&d.eosinofili==="abbondanti",
            wedge_eosinofili_profondo:()=>d.infiltrato_wedge_shaped&&d.eosinofili==="abbondanti",
            neutrofili_paracheratosi_psoriasi:()=>d.neutrofili_in_paracheratosi&&d.paracheratosi!=="assente",
            granuli_grossolani_lsc:()=>d.granuli_cheratoialina==="grossolani"&&d.acantosi!=="assente",
            saw_toothing_civatte:()=>d.saw_toothing&&d.corpi_civatte,
            plasmacellule_psoriasiforme:()=>["presenti","abbondanti"].includes(d.plasmacellule)&&d.pattern_primario==="psoriasiforme",
            granulomi_miescher_en:()=>d.granulomi_miescher&&d.pattern_primario==="panniculitico",
            emofagocitosi_lobulare:()=>d.emofagocitosi&&d.panniculite_tipo==="lobulare",
            // v1.9 nuovi
            ghost_cells_panniculite:()=>d.ghost_cells&&d.pattern_primario==="panniculitico",
            trombi_no_lcv:()=>d.trombi_fibrina&&!d.leucocitoclasia,
            mxa_cd123_lupus:()=>d.mxa_positivo||d.cd123_clusters,
            mastociti_cd25:()=>d.mastociti_aggregati&&d.cd25_aberrante,
            paracheratosi_mounds_manicotto:()=>d.paracheratosi_mounds&&d.infiltrato_manicotto
        };
        return chk[f]?chk[f]():false;
    },
    calcScore(c,exp,val,w){
        if(Array.isArray(exp))return exp.includes(val)?w:0;
        if(typeof exp==='boolean')return val===exp?w:0;
        return val===exp?w:0;
    },
    scorePat(k,p,d,excl){
        let s=0,m=0;
        Object.entries(p.major).forEach(([c,v])=>{m+=SC.MAJOR;s+=this.calcScore(c,v,d[c],SC.MAJOR);});
        if(p.minor)Object.entries(p.minor).forEach(([c,v])=>{m+=SC.MINOR;s+=this.calcScore(c,v,d[c],SC.MINOR);});
        const pct=m>0?Math.round((s/m)*100):0;
        return{pct:excl?Math.max(SC.MIN_EXCL,pct-SC.RED_PENALTY):pct,excl};
    },
    calc(d){
        const flags=RED_FLAGS.filter(rf=>this.evalFlag(rf.flag,d));
        const scores=[];
        Object.entries(DX).forEach(([k,p])=>{
            const excl=flags.some(rf=>rf.escludi.includes(k));
            const{pct}=this.scorePat(k,p,d,excl);
            scores.push({key:k,...p,pct,excl});
        });
        scores.sort((a,b)=>b.pct-a.pct);
        const high=scores.filter(x=>x.pct>=50);
        const low=scores.filter(x=>x.pct>=30&&x.pct<50).slice(0,3);
        const hints=this.hints(d);
        return{diagnoses:high,lowConf:low,flags,hints};
    },
    hints(d){
        const p=d.pattern_primario;
        const H={
            spongotico:{gen:"Spongotico aspecifico",escl:["Dermatofitosi (PAS)","MF (epidermotropismo senza spongiosi?)"],cons:["Eczema NOS","ACD vs ICD","Pitiriasi rosea"],col:["PAS","Sierologia lue"]},
            psoriasiforme:{gen:"Psoriasiforme aspecifico",escl:["Tinea (PAS)","Sifilide (plasmacellule?)"],cons:["Psoriasi iniziale","Dermatite seborroica"],col:["PAS","Sierologia lue"]},
            interfaccia_lichenoide:{gen:"Lichenoide",escl:["GVHD","Drug lichenoide"],cons:["Lichen planus","Lichenoid keratosis"],col:["IF se lupus"]},
            interfaccia_vacuolare:{gen:"Vacuolare",escl:["EM/TEN","Drug"],cons:["Lupus (MxA+)","Dermatomiosite (MxA+, mucina)"],col:["IF","Alcian blue","MxA"]},
            granulomatoso:{gen:"Granulomatoso",escl:["TB/funghi","Corpo estraneo"],cons:["Sarcoidosi","GA"],col:["ZN","PAS","Polarizzazione"]},
            granulomatoso_palizzata:{gen:"Granulomatoso palizzata",escl:["Infezione"],cons:["GA (mucina)","Necrobiosi lipoidica (sandwich)","Nodulo reumatoide (fibrina)"],col:["Alcian blue","PAS"]},
            vasculitico:{gen:"Vasculitico",escl:["Vasculopatia (no leucocitoclasia)"],cons:["LCV","Vasculite IgA"],col:["IF per Ig"]},
            vasculopatico:{gen:"Vasculopatico",escl:["Vasculite vera"],cons:["Livedoide","Coagulopatia"],col:["Perls","Coagulazione"]},
            panniculitico:{gen:"Panniculitico",escl:["SPTCL (atipici+emofagocitosi)","Pancreatica (ghost cells)"],cons:["EN (settale)","Lupus panniculitis (lobulare, follicoli)"],col:["IHC T se linfoma","ZN"]},
            mastocitario:{gen:"Mastocitario",escl:["Istiocitoma"],cons:["Mastocitosi cutanea","Urticaria pigmentosa"],col:["Giemsa","CD117","Triptasi","CD25"]}
        };
        return H[p]?[H[p]]:[];
    },
    needsIHCPanel(dx){
        const pso=dx.find(x=>x.key==='psoriasi_vulgaris');
        const spong=dx.find(x=>['dermatite_allergica_contatto','dermatite_atopica_acuta','lichen_simplex_chronicus'].includes(x.key));
        if(!pso||!spong)return false;
        return Math.abs(pso.pct-spong.pct)<20&&pso.pct>=50&&spong.pct>=50;
    }
};

const useForm=(init=1)=>{const[s,setS]=useState(init);return{step:s,next:useCallback(()=>setS(x=>x+1),[]),prev:useCallback(()=>setS(x=>x-1),[]),reset:useCallback(()=>setS(init),[init])};};
const useData=()=>{const[d,setD]=useState(INIT);return{data:d,upd:useCallback((f,v)=>setD(p=>({...p,[f]:v})),[]),reset:useCallback(()=>setD(INIT),[])};};

const Sel=memo(({label,value,onChange,opts})=>(
    <div><label className="block font-semibold mb-2">{label}</label>
    <select value={value} onChange={e=>onChange(e.target.value)}><option value="">Seleziona...</option>{opts.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}</select></div>
));

const Chk=memo(({label,checked,onChange,variant="default"})=>{
    const col={default:"border-slate-200 hover:bg-slate-50",warning:"border-amber-200 hover:bg-amber-50",danger:"border-red-300 hover:bg-red-50",eosinophil:"border-orange-200 hover:bg-orange-50",morpho:"border-indigo-300 hover:bg-indigo-50",teal:"border-teal-300 hover:bg-teal-50"};
    return(<label className={`flex items-center p-3 border-2 rounded-lg cursor-pointer ${col[variant]}`}><input type="checkbox" checked={checked} onChange={e=>onChange(e.target.checked)} className="mr-3"/><span className={variant==="danger"?"font-semibold":""}>{label}</span></label>);
});

const Radio=memo(({opt,sel,onSel})=>(
    <label className={`flex items-start p-4 border-2 rounded-lg cursor-pointer ${sel?'border-blue-600 bg-blue-50':'border-slate-200 hover:border-blue-300'}`}>
    <input type="radio" value={opt.value} checked={sel} onChange={()=>onSel(opt.value)} className="mt-1 mr-3"/>
    <div><div className="font-semibold">{opt.label}</div><div className="text-sm text-slate-600">{opt.desc}</div></div></label>
));

const Steps=memo(({cur})=>(
    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div className="flex items-center justify-between mb-2">{[1,2,3,4].map(s=>(
        <div key={s} className="flex items-center flex-1">
        <div className={`w-10 h-10 rounded-full flex items-center font-bold ${cur>=s?'bg-blue-600 text-white':'bg-slate-200 text-slate-600'}`} style={{justifyContent:'center'}}>{s}</div>
        {s<4&&<div className={`flex-1 h-1 mx-2 ${cur>s?'bg-blue-600':'bg-slate-200'}`}/>}</div>
    ))}</div>
    <div className="flex justify-between text-xs text-slate-600 mt-2"><span>Pattern</span><span>Epidermide</span><span>Infiltrato</span><span>Finalizza</span></div></div>
));

const Nav=memo(({onBack,onNext,canNext=true,nextLbl="Avanti ‚Üí"})=>(
    <div className="flex gap-4 mt-6">
    {onBack&&<button onClick={onBack} className="flex-1 bg-slate-200 py-3 rounded-lg font-semibold hover:bg-slate-300">‚Üê Indietro</button>}
    <button onClick={onNext} disabled={!canNext} className={`flex-1 py-3 rounded-lg font-semibold ${nextLbl.includes('Genera')?'bg-green-600 hover:bg-green-700':'bg-blue-600 hover:bg-blue-700'} text-white`} style={!canNext?{opacity:0.5,cursor:'not-allowed'}:{}}>{nextLbl}</button></div>
));

const IHCBox=memo(({ihcKey})=>{
    if(!ihcKey||!IHC_PERF[ihcKey])return null;
    const d=IHC_PERF[ihcKey];
    return(<div className="mt-2 p-2 bg-indigo-50 border border-indigo-200 rounded text-xs"><p className="font-semibold text-indigo-800">üìä {d.test}</p><p className="text-indigo-700">Sens: {d.sens}% | Spec: {d.spec}%</p></div>);
});

const IHCPanel=memo(()=>{
    const[exp,setExp]=useState(true);
    return(
    <div className="mb-6 p-4 bg-indigo-50 border-2 border-indigo-500 rounded-lg">
    <button onClick={()=>setExp(!exp)} className="flex items-center justify-between w-full text-left">
    <h3 className="text-lg font-bold text-indigo-900">üî¨ DD: Psoriasi vs Spongotico</h3><span className="text-indigo-600">{exp?'‚ñº':'‚ñ∂'}</span></button>
    {exp&&(<div className="mt-4"><p className="text-sm text-indigo-800 mb-3">Pannello IHC 2024-2025:</p>
    <table className="text-sm"><thead><tr className="bg-indigo-100"><th>Marcatore</th><th>Psoriasi</th><th>Spongotico</th><th>Note</th></tr></thead>
    <tbody>{IHC_PSO_SPONG.marcatori.map((m,i)=>(<tr key={i} className={i%2===0?'bg-white':'bg-indigo-50'}><td className="font-semibold text-indigo-800">{m.nome}</td><td className="text-green-700">{m.pso}</td><td className="text-amber-700">{m.spong}</td><td className="text-xs text-slate-600 italic">{m.note}</td></tr>))}</tbody></table>
    <p className="text-xs text-indigo-700 mt-3 italic">Fonte: {IHC_PSO_SPONG.fonte}</p></div>)}</div>);
});

const Bib=memo(({b})=>{
    const[exp,setExp]=useState(false);
    if(!b)return null;
    return(<div className="mt-3 border-t border-slate-200 pt-3">
    <button onClick={()=>setExp(!exp)} className="flex items-center justify-between w-full text-left p-2 bg-slate-50 rounded hover:bg-slate-100">
    <span className="text-sm font-semibold text-slate-700">üìö Bibliografia</span><span className="text-slate-500">{exp?'‚ñº':'‚ñ∂'}</span></button>
    {exp&&(<div className="mt-2 p-3 bg-white border border-slate-200 rounded text-xs">
    <p className="text-slate-700">{b.autori}. "{b.titolo}". {b.riv} ({b.anno}).</p>
    {b.pmid&&<a href={`https://pubmed.ncbi.nlm.nih.gov/${b.pmid}`} target="_blank" className="text-blue-600 hover:underline">PMID: {b.pmid}</a>}</div>)}</div>);
});

const DxCard=memo(({dx,idx})=>{
    const isLymph=dx.cat.includes('Linfoma');
    const isEos=dx.cat==='Eosinofilo';
    const isPann=dx.cat.includes('Panniculite');
    const bg=isLymph?'bg-red-50 border-red-500':isEos?'bg-orange-50 border-orange-500':isPann?'bg-teal-50 border-teal-500':'bg-blue-50 border-blue-500';
    return(<div className={`${bg} border-2 rounded-lg p-4 mb-4`}>
    <div className="flex justify-between items-center mb-2"><div><span className="px-2 py-1 bg-white rounded text-sm font-bold">#{idx+1}</span><h3 className="text-xl font-bold mt-1">{dx.nome}</h3><p className="text-sm text-slate-600">{dx.cat}</p></div>
    <div className="text-3xl font-bold text-blue-600 ml-4">{dx.pct}%</div></div>
    <p className="text-sm mb-3 bg-white rounded p-3">{dx.note}</p>
    {dx.color&&dx.color.length>0&&(<div className={`rounded p-3 mb-2 ${isLymph?'bg-red-100':isEos?'bg-orange-100':isPann?'bg-teal-100':'bg-amber-50'}`}>
    <p className="text-sm font-semibold mb-1">üî¨ {isLymph?'IHC OBBLIGATORIA':'Colorazioni'}:</p>
    <ul className="text-sm space-y-1">{dx.color.map((c,i)=><li key={i}>‚Ä¢ {c}</li>)}</ul></div>)}
    {dx.ihc&&<IHCBox ihcKey={dx.ihc}/>}
    <Bib b={dx.bib}/></div>);
});

const LowCard=memo(({dx})=>(
    <div className="border-2 border-dashed border-slate-300 rounded-lg p-4 bg-slate-50">
    <div className="flex justify-between items-center mb-2"><h4 className="font-semibold text-slate-700">{dx.nome}</h4><span className="text-lg font-bold text-slate-500">{dx.pct}%</span></div>
    <p className="text-xs text-slate-600">{dx.note}</p></div>
));

const HintsBox=memo(({hints})=>{
    if(!hints||hints.length===0)return null;
    const h=hints[0];
    return(<div className="mb-6 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
    <h3 className="text-lg font-bold text-blue-900 mb-3">üß≠ {h.gen}</h3>
    <div className="grid grid-cols-2 gap-4">
    <div><p className="text-sm font-semibold text-red-700 mb-1">‚ùå Escludere:</p><ul className="text-sm text-slate-700">{h.escl.map((e,i)=><li key={i}>‚Ä¢ {e}</li>)}</ul></div>
    <div><p className="text-sm font-semibold text-green-700 mb-1">‚úì Considerare:</p><ul className="text-sm text-slate-700">{h.cons.map((c,i)=><li key={i}>‚Ä¢ {c}</li>)}</ul></div></div>
    {h.col&&h.col.length>0&&<div className="bg-white rounded p-2 mt-3"><p className="text-sm"><strong>üî¨ Colorazioni:</strong> {h.col.join(', ')}</p></div>}</div>);
});

const Step1=memo(({data,upd,onNext})=>(
    <div><h2 className="text-2xl font-bold mb-4">Pattern Architetturale</h2>
    <div className="space-y-3">{PATTERNS.map(o=><Radio key={o.value} opt={o} sel={data.pattern_primario===o.value} onSel={v=>upd('pattern_primario',v)}/>)}</div>
    {data.pattern_primario==='panniculitico'&&(
    <div className="mt-4 p-4 bg-teal-50 border-2 border-teal-300 rounded-lg">
    <h3 className="font-bold text-teal-800 mb-3">üîç Tipo Panniculite</h3>
    <Sel label="Localizzazione" value={data.panniculite_tipo} onChange={v=>upd('panniculite_tipo',v)} opts={[{value:'settale',label:'Settale (setti) ‚Üí EN'},{value:'lobulare',label:'Lobulare (lobuli) ‚Üí Lupus, SPTCL, Pancreatica'}]}/>
    <div className="space-y-2 mt-3">
    <Chk label="Vasculite presente ‚Üí Er. indurato Bazin" checked={data.panniculite_vasculite} onChange={v=>upd('panniculite_vasculite',v)} variant="teal"/>
    <Chk label="‚ö†Ô∏è Ghost cells (adipociti fantasma) ‚Üí PANCREATICA!" checked={data.ghost_cells} onChange={v=>upd('ghost_cells',v)} variant="danger"/>
    <Chk label="Follicoli linfoidi con centri germinativi ‚Üí Lupus" checked={data.follicoli_germinativi} onChange={v=>upd('follicoli_germinativi',v)} variant="teal"/></div></div>)}
    <div className="mt-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
    <h3 className="font-bold text-blue-800 mb-3">‚è±Ô∏è Fase della Lesione</h3>
    <Sel label="Fase" value={data.fase_lesione} onChange={v=>upd('fase_lesione',v)} opts={[{value:'acuta',label:'Acuta (ore-giorni): spongiosi massiva, vescicolazione'},{value:'subacuta',label:'Subacuta (giorni-settimane): spongiosi moderata, paracheratosi'},{value:'cronica',label:'Cronica (settimane-mesi): acantosi, ipergranulosi, fibrosi'}]}/></div>
    <Nav onNext={onNext} canNext={!!data.pattern_primario}/></div>
));

const Step2=memo(({data,upd,onBack,onNext})=>(
    <div><h2 className="text-2xl font-bold mb-4">Epidermide</h2>
    <div className="space-y-4">
    <Sel label="Spongiosi" value={data.spongiosi} onChange={v=>upd('spongiosi',v)} opts={[{value:'assente',label:'Assente'},{value:'lieve',label:'Lieve'},{value:'moderata',label:'Moderata'},{value:'marcata',label:'Marcata'}]}/>
    <Sel label="Esocitosi" value={data.esocitosi} onChange={v=>upd('esocitosi',v)} opts={[{value:'assente',label:'Assente'},{value:'lieve',label:'Lieve'},{value:'presente',label:'Presente'},{value:'marcata',label:'Marcata'}]}/>
    <Sel label="Acantosi" value={data.acantosi} onChange={v=>upd('acantosi',v)} opts={[{value:'assente',label:'Assente'},{value:'lieve',label:'Lieve'},{value:'moderata',label:'Moderata'},{value:'marcata',label:'Marcata'}]}/>
    <Sel label="Paracheratosi" value={data.paracheratosi} onChange={v=>upd('paracheratosi',v)} opts={[{value:'assente',label:'Assente'},{value:'focale',label:'Focale'},{value:'moderata',label:'Moderata'},{value:'marcata',label:'Marcata'}]}/>
    <div className="grid grid-cols-2 gap-4">
    <Sel label="Ipergranulosi" value={data.ipergranulosi} onChange={v=>upd('ipergranulosi',v)} opts={[{value:'no',label:'No'},{value:'si',label:'S√¨'}]}/>
    <Sel label="Ipogranulosi" value={data.ipogranulosi} onChange={v=>upd('ipogranulosi',v)} opts={[{value:'no',label:'No'},{value:'si',label:'S√¨'}]}/></div>
    <Sel label="Vacuolizzazione basale" value={data.vacuolizzazione_basale} onChange={v=>upd('vacuolizzazione_basale',v)} opts={[{value:'assente',label:'Assente'},{value:'presente',label:'Presente'},{value:'marcata',label:'Marcata'}]}/>
    <Sel label="Necrosi cheratinociti" value={data.necrosi_keratinociti} onChange={v=>upd('necrosi_keratinociti',v)} opts={[{value:'assente',label:'Assente'},{value:'presente',label:'Presente'},{value:'marcata',label:'Marcata'}]}/>
    <div className="p-4 bg-violet-50 border-2 border-violet-300 rounded-lg mt-4">
    <h3 className="font-bold text-violet-800 mb-2">üîç Clues Morfologici</h3>
    <div className="space-y-3">
    <Chk label="Neutrofili paracheratosi (Segno √ë) ‚Üí Psoriasi" checked={data.neutrofili_in_paracheratosi} onChange={v=>upd('neutrofili_in_paracheratosi',v)} variant="morpho"/>
    <Chk label="Paracheratosi 'a tumuli' (mounds) ‚Üí Pitiriasi rosea" checked={data.paracheratosi_mounds} onChange={v=>upd('paracheratosi_mounds',v)} variant="morpho"/>
    <Chk label="Necrosi cheratinociti SUPERFICIALI ‚Üí Irritativa (vs ACD)" checked={data.necrosi_cheratino_superficiale} onChange={v=>upd('necrosi_cheratino_superficiale',v)} variant="morpho"/>
    <Chk label="Assottigliamento soprapapillare ‚Üí Psoriasi" checked={data.assottigliamento_soprapapillare} onChange={v=>upd('assottigliamento_soprapapillare',v)} variant="morpho"/>
    <Chk label="Capillari dilatati papille ‚Üí Psoriasi" checked={data.capillari_dilatati_papille} onChange={v=>upd('capillari_dilatati_papille',v)} variant="morpho"/>
    <Chk label="Saw-toothing (dente sega) ‚Üí LP" checked={data.saw_toothing} onChange={v=>upd('saw_toothing',v)} variant="morpho"/>
    <Chk label="Ipergranulosi a cuneo ‚Üí LP" checked={data.ipergranulosi_cuneo} onChange={v=>upd('ipergranulosi_cuneo',v)} variant="morpho"/>
    <Chk label="Plugging follicolare ‚Üí Lupus" checked={data.plugging_follicolare} onChange={v=>upd('plugging_follicolare',v)} variant="morpho"/>
    <Sel label="Granuli cheratoialina" value={data.granuli_cheratoialina} onChange={v=>upd('granuli_cheratoialina',v)} opts={[{value:'normali',label:'Normali'},{value:'diminuiti',label:'Diminuiti ‚Üí Psoriasi'},{value:'grossolani',label:'Grossolani ‚Üí LSC'}]}/></div></div></div>
    <Nav onBack={onBack} onNext={onNext}/></div>
));

const Step3=memo(({data,upd,onBack,onNext})=>(
    <div><h2 className="text-2xl font-bold mb-4">Derma e Infiltrato</h2>
    <div className="space-y-4">
    <Sel label="Distribuzione" value={data.infiltrato_distribuzione} onChange={v=>upd('infiltrato_distribuzione',v)} opts={[{value:'perivascolare_superficiale',label:'Perivascolare sup'},{value:'perivascolare_profondo',label:'Perivascolare prof'},{value:'banda_lichenoide',label:'Banda lichenoide'},{value:'interstiziale',label:'Interstiziale'},{value:'perivascolare_perianessiale',label:'Perivascolare+perianessiale'},{value:'derma_medio_profondo',label:'Derma medio-prof'}]}/>
    <Sel label="Densit√†" value={data.infiltrato_densita} onChange={v=>upd('infiltrato_densita',v)} opts={[{value:'scarso',label:'Scarso'},{value:'moderato',label:'Moderato'},{value:'denso',label:'Denso'}]}/>
    <Sel label="Eosinofili" value={data.eosinofili} onChange={v=>upd('eosinofili',v)} opts={[{value:'assenti',label:'Assenti'},{value:'rari',label:'Rari'},{value:'presenti',label:'Presenti'},{value:'abbondanti',label:'Abbondanti'}]}/>
    <Sel label="Neutrofili" value={data.neutrofili} onChange={v=>upd('neutrofili',v)} opts={[{value:'assenti',label:'Assenti'},{value:'rari',label:'Rari'},{value:'presenti',label:'Presenti'},{value:'abbondanti',label:'Abbondanti'}]}/>
    <Sel label="Plasmacellule" value={data.plasmacellule} onChange={v=>upd('plasmacellule',v)} opts={[{value:'assenti',label:'Assenti'},{value:'presenti',label:'Presenti ‚Üí Sifilide?'},{value:'abbondanti',label:'Abbondanti ‚Üí SIFILIDE!'}]}/>
    <Sel label="Mucina dermica" value={data.mucina_dermica} onChange={v=>upd('mucina_dermica',v)} opts={[{value:'assente',label:'Assente'},{value:'focale',label:'Focale'},{value:'abbondante',label:'Abbondante ‚Üí Lupus/GA'}]}/>
    <Sel label="Eritrociti extravasati" value={data.eritrociti_extravasati} onChange={v=>upd('eritrociti_extravasati',v)} opts={[{value:'assenti',label:'Assenti'},{value:'presenti',label:'Presenti'},{value:'abbondanti',label:'Abbondanti'}]}/>
    <div className="p-4 bg-orange-50 border-2 border-orange-200 rounded-lg"><h3 className="font-bold text-orange-800 mb-3">üî∂ Pattern Eosinofilo</h3>
    <div className="space-y-3">
    <Chk label="Flame figures ‚Üí Wells" checked={data.flame_figures} onChange={v=>upd('flame_figures',v)} variant="eosinophil"/>
    <Chk label="Wedge-shaped ‚Üí Bite" checked={data.infiltrato_wedge_shaped} onChange={v=>upd('infiltrato_wedge_shaped',v)} variant="eosinophil"/>
    <Chk label="Eosinofili profondi ‚Üí Drug" checked={data.eosinofili_perivascolari_profondi} onChange={v=>upd('eosinofili_perivascolari_profondi',v)} variant="eosinophil"/>
    <Chk label="Fibrosi verticale ‚Üí Prurigo" checked={data.fibrosi_dermica} onChange={v=>upd('fibrosi_dermica',v)} variant="eosinophil"/>
    <Chk label="Centrato follicoli ‚Üí Follicolite eos" checked={data.infiltrato_follicolare} onChange={v=>upd('infiltrato_follicolare',v)} variant="eosinophil"/></div></div>
    <div className="p-4 bg-cyan-50 border-2 border-cyan-200 rounded-lg"><h3 className="font-bold text-cyan-900 mb-3">üî∑ Vasculite vs Vasculopatia</h3>
    <div className="space-y-3">
    <Chk label="Leucocitoclasia (polvere nucleare) ‚Üí Vasculite vera" checked={data.leucocitoclasia} onChange={v=>upd('leucocitoclasia',v)}/>
    <Chk label="Trombi fibrina intraluminali ‚Üí Vasculopatia livedoide" checked={data.trombi_fibrina} onChange={v=>upd('trombi_fibrina',v)}/>
    <Chk label="Depositi emosiderina (Perls+)" checked={data.depositi_emosiderina} onChange={v=>upd('depositi_emosiderina',v)}/></div></div>
    <div className="p-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg"><h3 className="font-bold text-indigo-900 mb-3">üî¨ IHC Specifici (Lupus/DM)</h3>
    <div className="space-y-3">
    <Chk label="MxA+ (firma IFN tipo I) ‚Üí Lupus/Dermatomiosite" checked={data.mxa_positivo} onChange={v=>upd('mxa_positivo',v)}/>
    <Chk label="CD123 clusters ‚Üí Lupus (vs sparso in MF)" checked={data.cd123_clusters} onChange={v=>upd('cd123_clusters',v)}/></div></div>
    <div className="p-4 bg-red-50 border-2 border-red-200 rounded-lg"><h3 className="font-bold text-red-900 mb-3">‚ö†Ô∏è Sospetto Linfoma/Panniculite</h3>
    <div className="space-y-3">
    <Sel label="Linfociti atipici" value={data.linfociti_atipici} onChange={v=>upd('linfociti_atipici',v)} opts={[{value:'assenti',label:'Assenti'},{value:'presenti',label:'Presenti'},{value:'abbondanti',label:'Abbondanti'}]}/>
    <Sel label="Epidermotropismo" value={data.epidermotropismo} onChange={v=>upd('epidermotropismo',v)} opts={[{value:'assente',label:'Assente'},{value:'presente',label:'Presente'},{value:'marcato',label:'Marcato'}]}/>
    <Chk label="Alone chiaro ‚Üí MF" checked={data.alone_chiaro} onChange={v=>upd('alone_chiaro',v)} variant="danger"/>
    <Chk label="Granulomi Miescher ‚Üí EN" checked={data.granulomi_miescher} onChange={v=>upd('granulomi_miescher',v)} variant="danger"/>
    <Chk label="Necrosi adipociti ‚Üí SPTCL" checked={data.necrosi_adipociti} onChange={v=>upd('necrosi_adipociti',v)} variant="danger"/>
    <Chk label="Emofagocitosi ‚Üí SPTCL" checked={data.emofagocitosi} onChange={v=>upd('emofagocitosi',v)} variant="danger"/></div></div></div>
    <Nav onBack={onBack} onNext={onNext}/></div>
));

const Step4=memo(({data,upd,onBack,onGen})=>(
    <div><h2 className="text-2xl font-bold mb-4">Completamento</h2>
    <div className="space-y-4">
    <Sel label="Vasculite" value={data.vasculite} onChange={v=>upd('vasculite',v)} opts={[{value:'no',label:'No'},{value:'si',label:'S√¨'}]}/>
    <Chk label="Microascessi Munro" checked={data.microascessi_munro} onChange={v=>upd('microascessi_munro',v)}/>
    <div><label className="block font-semibold mb-2">üö© Red Flags - Granulomatosi Palizzata</label>
    <div className="space-y-2">
    <Chk label="Palisading + mucina ‚Üí GA" checked={data.palisading_necrosi_mucina} onChange={v=>upd('palisading_necrosi_mucina',v)} variant="warning"/>
    <Chk label="Necrobiosi 'a sandwich' ‚Üí Necrobiosi lipoidica" checked={data.necrobiosi_sandwich} onChange={v=>upd('necrobiosi_sandwich',v)} variant="warning"/>
    <Chk label="Fibrina centrale eosinofila ‚Üí Nodulo reumatoide" checked={data.fibrina_centrale} onChange={v=>upd('fibrina_centrale',v)} variant="warning"/>
    <Chk label="Corpi Civatte ‚Üí LP" checked={data.corpi_civatte} onChange={v=>upd('corpi_civatte',v)} variant="warning"/></div></div>
    <div><label className="block font-semibold mb-2">‚ö†Ô∏è Bollosi</label>
    <div className="space-y-2">
    <Chk label="‚ö†Ô∏è Acantolisi ‚Üí PEMFIGO" checked={data.acantolisi} onChange={v=>upd('acantolisi',v)} variant="danger"/>
    <Chk label="‚ö†Ô∏è Bolle intraepidermiche" checked={data.bolle_intraepidermiche} onChange={v=>upd('bolle_intraepidermiche',v)} variant="danger"/>
    <Chk label="‚ö†Ô∏è Bolle subepidermiche ‚Üí PEMFIGOIDE" checked={data.bolle_subepidermiche} onChange={v=>upd('bolle_subepidermiche',v)} variant="danger"/></div></div>
    <div><label className="block font-semibold mb-2">üî¨ Mastocitosi</label>
    <div className="space-y-2">
    <Chk label="Mastociti aggregati (‚â•15)" checked={data.mastociti_aggregati} onChange={v=>upd('mastociti_aggregati',v)}/>
    <Chk label="CD117+ (c-kit)" checked={data.cd117_pos} onChange={v=>upd('cd117_pos',v)}/>
    <Chk label="CD25 aberrante ‚Üí Sospetto sistemico!" checked={data.cd25_aberrante} onChange={v=>upd('cd25_aberrante',v)} variant="danger"/></div></div>
    <Sel label="Edema dermico" value={data.edema_dermico} onChange={v=>upd('edema_dermico',v)} opts={[{value:'assente',label:'Assente'},{value:'lieve',label:'Lieve'},{value:'moderato',label:'Moderato'},{value:'marcato',label:'Marcato'}]}/>
    <Chk label="Infiltrato perianessiale profondo ‚Üí Lupus" checked={data.infiltrato_perianessiale_profondo} onChange={v=>upd('infiltrato_perianessiale_profondo',v)}/>
    <Chk label="Infiltrato 'a manicotto' ‚Üí Pitiriasi rosea" checked={data.infiltrato_manicotto} onChange={v=>upd('infiltrato_manicotto',v)}/>
    <div className="p-4 bg-blue-50 border-2 border-blue-200 rounded-lg"><h3 className="font-bold text-blue-900 mb-3">üìã Contesto</h3>
    <Chk label="Storia farmaci" checked={data.storia_farmaci} onChange={v=>upd('storia_farmaci',v)}/>
    <Chk label="Sospetta puntura" checked={data.storia_puntura_insetto} onChange={v=>upd('storia_puntura_insetto',v)}/></div></div>
    <Nav onBack={onBack} onNext={onGen} nextLabel="üî¨ Genera Diagnosi"/></div>
));

const Results=memo(({dx,lowConf,flags,hints,showIHC,onMod,onExp})=>{
    const hasLymph=dx.some(d=>d.cat.includes('Linfoma'));
    const hasEos=dx.some(d=>d.cat==='Eosinofilo');
    const hasPann=dx.some(d=>d.cat.includes('Panniculite'));
    const hasHigh=dx.length>0;
    return(<div className="bg-white rounded-xl shadow-lg p-6">
    <div className="flex items-center justify-between mb-6"><h2 className="text-2xl font-bold">üìã Diagnosi Differenziale</h2>
    <div className="flex gap-2"><button onClick={onExp} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">üíæ Esporta</button>
    <button onClick={onMod} className="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 text-sm font-semibold">‚Üê Modifica</button></div></div>
    {showIHC&&<IHCPanel/>}
    {hasLymph&&<div className="mb-6 p-4 bg-red-50 border-2 border-red-500 rounded-lg"><h3 className="text-lg font-bold text-red-900 mb-2">‚ö†Ô∏è SOSPETTO LINFOMA</h3><p className="text-sm text-red-800">IHC: CD3,CD4,CD8,CD7,TOX | PCR TCR</p></div>}
    {hasPann&&<div className="mb-6 p-4 bg-teal-50 border-2 border-teal-500 rounded-lg"><h3 className="text-lg font-bold text-teal-900 mb-2">üîç PATTERN PANNICULITICO</h3><p className="text-sm text-teal-800">Settale (EN) vs Lobulare (Lupus, SPTCL). Se linfociti atipici ‚Üí IHC T!</p></div>}
    {hasEos&&<div className="mb-6 p-4 bg-orange-50 border-2 border-orange-500 rounded-lg"><h3 className="text-lg font-bold text-orange-900 mb-2">üî∂ PATTERN EOSINOFILO</h3><p className="text-sm text-orange-800">Farmaci? Punture? Flame figures = Wells.</p></div>}
    {flags.length>0&&<div className="mb-6 p-4 bg-amber-50 border-2 border-amber-500 rounded-lg"><h3 className="text-lg font-bold text-amber-900 mb-2">üö© RED FLAGS</h3><div className="text-sm text-amber-800 space-y-1">{flags.map((f,i)=><p key={i}>‚Ä¢ <strong>{f.diagnosi}</strong></p>)}</div></div>}
    {hasHigh&&<div className="space-y-4 mb-6">{dx.map((d,i)=><DxCard key={d.key} dx={d} idx={i}/>)}</div>}
    {!hasHigh&&(<div className="space-y-4"><HintsBox hints={hints}/>
    {lowConf&&lowConf.length>0&&(<div className="mb-6"><h3 className="text-lg font-semibold text-slate-700 mb-3">ü§î Bassa confidenza</h3><div className="space-y-3">{lowConf.map(d=><LowCard key={d.key} dx={d}/>)}</div></div>)}
    {(!lowConf||lowConf.length===0)&&(!hints||hints.length===0)&&(<div className="p-6 bg-slate-50 border-2 border-slate-200 rounded-lg text-center"><p className="font-semibold text-slate-700 mb-2">üî¨ Pattern non diagnostico</p><p className="text-sm text-slate-600">Considera livelli aggiuntivi, correlazione clinica, nuova biopsia.</p></div>)}</div>)}
    <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg"><p className="text-sm text-blue-900"><strong>üí°</strong> Diagnosi pattern-based. Correlazione clinico-patologica sempre necessaria.</p></div></div>);
});

const App=()=>{
    const{step,next,prev,reset:resetStep}=useForm(1);
    const{data,upd,reset:resetData}=useData();
    const[showRes,setShowRes]=useState(false);
    const[res,setRes]=useState({diagnoses:[],flags:[]});
    const handleReset=useCallback(()=>{if(confirm('Reset?')){resetData();resetStep();setShowRes(false);}},[]); 
    const handleCalc=useCallback(()=>{setRes(Engine.calc(data));setShowRes(true);},[data]);
    const showIHC=useMemo(()=>Engine.needsIHCPanel(res.diagnoses),[res.diagnoses]);
    const handleExp=useCallback(()=>{
        let c=`REFERTO DERMATOPATOLOGICO - DermPath v1.9\nData: ${new Date().toLocaleDateString('it-IT')}\nPattern: ${data.pattern_primario}`;
        if(data.panniculite_tipo)c+=` (${data.panniculite_tipo})`;
        c+='\n';
        if(res.diagnoses&&res.diagnoses.length>0)c+=`\nDIAGNOSI:\n${res.diagnoses.map((d,i)=>`${i+1}. ${d.nome} (${d.pct}%)\n   ${d.note}`).join('\n\n')}`;
        if(res.lowConf&&res.lowConf.length>0&&(!res.diagnoses||res.diagnoses.length===0))c+=`\nDA CONSIDERARE:\n${res.lowConf.map((d,i)=>`${i+1}. ${d.nome} (${d.pct}%)`).join('\n')}`;
        if(showIHC)c+=`\n\n‚ö†Ô∏è DD EQUIVOCA - Pannello IHC: Ki-67, p53, CD34, IL-36Œ≥`;
        c+=`\n\n---\nDermPath v1.9 - Correlazione clinico-patologica necessaria.`;
        const b=new Blob([c],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`referto_${Date.now()}.txt`;a.click();
    },[data,res,showIHC]);
    const renderStep=useMemo(()=>{
        switch(step){
            case 1:return<Step1 data={data} upd={upd} onNext={next}/>;
            case 2:return<Step2 data={data} upd={upd} onBack={prev} onNext={next}/>;
            case 3:return<Step3 data={data} upd={upd} onBack={prev} onNext={next}/>;
            case 4:return<Step4 data={data} upd={upd} onBack={prev} onGen={handleCalc}/>;
            default:return null;
        }
    },[step,data,upd,next,prev,handleCalc]);
    return(<div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4"><div className="max-w-4xl">
    <div className="bg-white rounded-xl shadow-lg p-6 mb-6"><div className="flex items-center justify-between"><div><h1 className="text-3xl font-bold text-slate-800">üî¨ DermPath v1.9</h1><p className="text-slate-600 mt-1">+ ICD, Pitiriasi rosea, Mastocitosi, Vasculopatia, MxA/CD123</p></div>
    <button onClick={handleReset} className="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-semibold">üîÑ Reset</button></div></div>
    {!showRes&&<Steps cur={step}/>}
    {!showRes?<div className="bg-white rounded-xl shadow-lg p-6">{renderStep}</div>:<Results dx={res.diagnoses} lowConf={res.lowConf} flags={res.flags} hints={res.hints} showIHC={showIHC} onMod={()=>setShowRes(false)} onExp={handleExp}/>}
    <div className="mt-6 text-center text-sm text-slate-600"><p>DermPath v1.9 - ICD vs ACD | Pitiriasi rosea | Panniculite pancreatica | Mastocitosi | Necrobiosi lipoidica | Vasculopatia livedoide | Dermatomiosite | MxA/CD123</p></div></div></div>);
};
ReactDOM.render(<App/>,document.getElementById('root'));
    </script>
</body>
</html>
