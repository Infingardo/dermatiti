<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DermPath - Sistema Diagnostico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const DermPathDiagnostic = () => {
            const [step, setStep] = useState(1);
            const [patternData, setPatternData] = useState({
                pattern_primario: '',
                spongiosi: '',
                esocitosi: '',
                acantosi: '',
                paracheratosi: '',
                ipergranulosi: '',
                ipogranulosi: '',
                vacuolizzazione_basale: '',
                necrosi_keratinociti: '',
                infiltrato_distribuzione: '',
                infiltrato_densita: '',
                eosinofili: '',
                neutrofili: '',
                linfociti_atipici: '',
                epidermotropismo: '',
                alone_chiaro: false,
                cellule_cerebriformi: false,
                cd30_positivi: false,
                microascessi_munro: false,
                vasculite: '',
                eritrociti_extravasati: '',
                sede_anatomica: '',
                note_cliniche: ''
            });

            const [diagnoses, setDiagnoses] = useState([]);
            const [showResults, setShowResults] = useState(false);

            const diagnosticPatterns = {
                dermatite_allergica_contatto: {
                    nome: "Dermatite allergica da contatto (fase acuta)",
                    categoria: "Spongotico",
                    criteri_maggiori: {
                        pattern_primario: "spongotico",
                        spongiosi: "marcata",
                        esocitosi: "presente"
                    },
                    criteri_minori: {
                        eosinofili: ["presenti", "abbondanti"],
                        infiltrato_distribuzione: "perivascolare_superficiale"
                    },
                    note: "Pattern classico da ipersensibilit√† tipo IV. Correlazione con patch test.",
                    colorazioni: ["Nessuna colorazione speciale necessaria"],
                    bibliografia: "Ackerman AB, 2005"
                },
                dermatite_atopica_acuta: {
                    nome: "Dermatite atopica (fase acuta)",
                    categoria: "Spongotico",
                    criteri_maggiori: {
                        pattern_primario: "spongotico",
                        spongiosi: ["moderata", "marcata"],
                        esocitosi: "presente"
                    },
                    criteri_minori: {
                        eosinofili: ["presenti", "abbondanti"],
                        paracheratosi: "focale"
                    },
                    note: "Fase acuta/subacuta. Se cronicizzata: acantosi, ipergranulosi.",
                    colorazioni: ["PAS (escludere dermatofitosi)"],
                    bibliografia: "Elder DE, 2020"
                },
                psoriasi_vulgaris: {
                    nome: "Psoriasi vulgaris",
                    categoria: "Psoriasiforme",
                    criteri_maggiori: {
                        pattern_primario: "psoriasiforme",
                        acantosi: "marcata",
                        paracheratosi: ["moderata", "marcata"],
                        ipogranulosi: "si"
                    },
                    criteri_minori: {
                        neutrofili: ["presenti", "abbondanti"],
                        microascessi_munro: true
                    },
                    note: "Allungamento regolare rete ridges. Capillari dilatati.",
                    colorazioni: ["PAS per escludere tinea"],
                    bibliografia: "Nestle FO, 2009"
                },
                lichen_planus: {
                    nome: "Lichen planus",
                    categoria: "Interfaccia/Lichenoide",
                    criteri_maggiori: {
                        pattern_primario: "interfaccia_lichenoide",
                        infiltrato_distribuzione: "banda_lichenoide",
                        vacuolizzazione_basale: "presente"
                    },
                    criteri_minori: {
                        necrosi_keratinociti: "presente",
                        ipergranulosi: "si"
                    },
                    note: "Infiltrato a banda. Corpi di Civatte (cheratinociti necrotici).",
                    colorazioni: ["PAS per escludere GVHD"],
                    bibliografia: "Shiohara T, 2012"
                },
                lupus_discoide: {
                    nome: "Lupus eritematoso cutaneo cronico (discoide)",
                    categoria: "Interfaccia",
                    criteri_maggiori: {
                        pattern_primario: "interfaccia_vacuolare",
                        vacuolizzazione_basale: "presente",
                        infiltrato_distribuzione: "perivascolare_perianessiale"
                    },
                    criteri_minori: {
                        ipergranulosi: "si"
                    },
                    note: "Tappi folliculari. Mucina dermica. Membrana basale ispessita.",
                    colorazioni: ["PAS (membrana basale)", "Alcian blue (mucina)"],
                    bibliografia: "Kuhn A, 2007"
                },
                eritema_multiforme: {
                    nome: "Eritema multiforme",
                    categoria: "Interfaccia",
                    criteri_maggiori: {
                        pattern_primario: "interfaccia_lichenoide",
                        necrosi_keratinociti: "marcata",
                        vacuolizzazione_basale: "presente"
                    },
                    criteri_minori: {
                        eosinofili: "presenti"
                    },
                    note: "Necrosi cheratinocitaria massiva. Spesso post-HSV o farmaci.",
                    colorazioni: [],
                    bibliografia: "Bastuji-Garin S, 1993"
                },
                vasculite_leucocitoclastica: {
                    nome: "Vasculite leucocitoclastica",
                    categoria: "Vasculitico",
                    criteri_maggiori: {
                        pattern_primario: "perivascolare",
                        vasculite: "si",
                        neutrofili: "abbondanti"
                    },
                    criteri_minori: {
                        eritrociti_extravasati: "presenti"
                    },
                    note: "Porpora palpabile. Indagare: infezioni, farmaci, connettiviti.",
                    colorazioni: ["PAS/Alcian blue per depositi vascolari"],
                    bibliografia: "Carlson JA, 2006"
                },
                micosi_fungoide_early: {
                    nome: "Micosi fungoide (early patch/plaque)",
                    categoria: "Linfoma cutaneo T",
                    criteri_maggiori: {
                        pattern_primario: ["spongotico", "interfaccia_lichenoide"],
                        infiltrato_distribuzione: ["perivascolare_superficiale", "banda_lichenoide"],
                        linfociti_atipici: "presenti"
                    },
                    criteri_minori: {
                        epidermotropismo: "presente",
                        alone_chiaro: true
                    },
                    note: "‚ö†Ô∏è LINFOMA! Linfociti atipici epidermotropi con alone chiaro.",
                    colorazioni: ["IHC MANDATORIA: CD3+, CD4+>CD8+, CD7 loss"],
                    workup_molecolare: "PCR riarrangiamento TCR (clonalit√† T)",
                    bibliografia: "Willemze R, 2019"
                },
                micosi_fungoide_tumor: {
                    nome: "Micosi fungoide (tumor stage)",
                    categoria: "Linfoma cutaneo T",
                    criteri_maggiori: {
                        pattern_primario: "perivascolare",
                        infiltrato_distribuzione: "perivascolare_profondo",
                        infiltrato_densita: "denso",
                        linfociti_atipici: "abbondanti"
                    },
                    criteri_minori: {
                        cellule_cerebriformi: true
                    },
                    note: "‚ö†Ô∏è LINFOMA AVANZATO! Noduli/tumori. Rischio trasformazione.",
                    colorazioni: ["IHC: CD3+, CD4+, perdita CD7", "Ki67", "CD30 se trasformazione"],
                    workup_molecolare: "PCR TCR + staging",
                    bibliografia: "Guitart J, 2018"
                },
                linfoma_anaplastico_cutaneo: {
                    nome: "Linfoma anaplastico cutaneo primitivo (pcALCL)",
                    categoria: "Linfoma cutaneo CD30+",
                    criteri_maggiori: {
                        pattern_primario: "perivascolare",
                        infiltrato_distribuzione: "perivascolare_profondo",
                        infiltrato_densita: "denso",
                        linfociti_atipici: "abbondanti",
                        cd30_positivi: true
                    },
                    note: "‚ö†Ô∏è LINFOMA! CD30+ anaplastiche. Buona prognosi se confinato.",
                    colorazioni: ["IHC: CD30+ diffuso", "ALK negativo", "CD3+"],
                    workup_molecolare: "Staging TC, biopsia linfonodo sentinella",
                    bibliografia: "Kadin ME, 2018"
                }
            };

            const calculateDiagnoses = () => {
                const results = [];

                Object.entries(diagnosticPatterns).forEach(([key, pattern]) => {
                    let score = 0;
                    let maxScore = 0;

                    Object.entries(pattern.criteri_maggiori).forEach(([criterio, valoreAtteso]) => {
                        maxScore += 3;
                        const valoreCorrente = patternData[criterio];

                        if (Array.isArray(valoreAtteso)) {
                            if (valoreAtteso.includes(valoreCorrente)) score += 3;
                        } else if (typeof valoreAtteso === 'boolean') {
                            if (valoreCorrente === valoreAtteso) score += 3;
                        } else {
                            if (valoreCorrente === valoreAtteso) score += 3;
                        }
                    });

                    Object.entries(pattern.criteri_minori || {}).forEach(([criterio, valoreAtteso]) => {
                        maxScore += 1;
                        const valoreCorrente = patternData[criterio];

                        if (Array.isArray(valoreAtteso)) {
                            if (valoreAtteso.includes(valoreCorrente)) score += 1;
                        } else if (typeof valoreAtteso === 'boolean') {
                            if (valoreCorrente === valoreAtteso) score += 1;
                        } else {
                            if (valoreCorrente === valoreAtteso) score += 1;
                        }
                    });

                    const percentuale = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;

                    if (percentuale >= 40) {
                        results.push({ ...pattern, percentuale });
                    }
                });

                results.sort((a, b) => b.percentuale - a.percentuale);
                setDiagnoses(results);
                setShowResults(true);
            };

            const handleReset = () => {
                if (confirm('Resettare tutti i dati?')) {
                    setPatternData({
                        pattern_primario: '', spongiosi: '', esocitosi: '', acantosi: '',
                        paracheratosi: '', ipergranulosi: '', ipogranulosi: '',
                        vacuolizzazione_basale: '', necrosi_keratinociti: '',
                        infiltrato_distribuzione: '', infiltrato_densita: '',
                        eosinofili: '', neutrofili: '', linfociti_atipici: '',
                        epidermotropismo: '', alone_chiaro: false, cellule_cerebriformi: false,
                        cd30_positivi: false, microascessi_munro: false, vasculite: '',
                        eritrociti_extravasati: '', sede_anatomica: '', note_cliniche: ''
                    });
                    setStep(1);
                    setShowResults(false);
                    setDiagnoses([]);
                }
            };

            const generateReport = () => {
                const hasLymphoma = diagnoses.some(d => d.categoria.includes('Linfoma'));
                
                const reportContent = `
================================================================================
REFERTO ANATOMOPATOLOGICO - DERMATOPATOLOGIA
================================================================================
Data: ${new Date().toLocaleDateString('it-IT')}

PATTERN: ${patternData.pattern_primario.toUpperCase().replace(/_/g, ' ')}

EPIDERMIDE:
- Spongiosi: ${patternData.spongiosi || 'non valutata'}
- Acantosi: ${patternData.acantosi || 'assente'}
- Paracheratosi: ${patternData.paracheratosi || 'assente'}

DERMA:
- Distribuzione infiltrato: ${patternData.infiltrato_distribuzione || 'non specificata'}
- Linfociti atipici: ${patternData.linfociti_atipici || 'non valutati'}

Sede: ${patternData.sede_anatomica || 'non specificata'}

================================================================================
DIAGNOSI DIFFERENZIALE:
================================================================================

${diagnoses.map((d, i) => `${i + 1}. ${d.nome.toUpperCase()} (${d.percentuale}%)
   ${d.note}
   ${d.colorazioni.length > 0 ? `IHC: ${d.colorazioni.join(', ')}` : ''}`).join('\n\n')}

${hasLymphoma ? '\n‚ö†Ô∏è SOSPETTO LINFOMA - IHC e PCR obbligatorie\n' : ''}
================================================================================
`;

                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `referto_dermpath_${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold text-slate-800">üî¨ DermPath</h1>
                                    <p className="text-slate-600 mt-1">Sistema diagnostico pattern-based</p>
                                </div>
                                <button onClick={handleReset} 
                                    className="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-semibold">
                                    üîÑ Reset
                                </button>
                            </div>
                        </div>

                        {!showResults && (
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <div className="flex items-center justify-between mb-2">
                                    {[1, 2, 3, 4].map((s) => (
                                        <div key={s} className="flex items-center flex-1">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                                                step >= s ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'
                                            }`}>{s}</div>
                                            {s < 4 && <div className={`flex-1 h-1 mx-2 ${step > s ? 'bg-blue-600' : 'bg-slate-200'}`} />}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex justify-between text-xs text-slate-600 mt-2">
                                    <span>Pattern</span>
                                    <span>Epidermide</span>
                                    <span>Infiltrato</span>
                                    <span>Finalizza</span>
                                </div>
                            </div>
                        )}

                        {!showResults && (
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                {step === 1 && (
                                    <div>
                                        <h2 className="text-2xl font-bold mb-4">Pattern Architetturale</h2>
                                        
                                        <div className="space-y-3">
                                            {[
                                                { value: 'spongotico', label: 'Spongotico', desc: 'Edema intercellulare' },
                                                { value: 'psoriasiforme', label: 'Psoriasiforme', desc: 'Allungamento rete ridges' },
                                                { value: 'interfaccia_lichenoide', label: 'Interfaccia Lichenoide', desc: 'Infiltrato a banda' },
                                                { value: 'interfaccia_vacuolare', label: 'Interfaccia Vacuolare', desc: 'Vacuoli basali' },
                                                { value: 'perivascolare', label: 'Perivascolare', desc: 'Infiltrato attorno vasi' },
                                                { value: 'vasculitico', label: 'Vasculitico', desc: 'Danno vascolare' }
                                            ].map(opt => (
                                                <label key={opt.value} className={`flex items-start p-4 border-2 rounded-lg cursor-pointer ${
                                                    patternData.pattern_primario === opt.value 
                                                        ? 'border-blue-600 bg-blue-50' 
                                                        : 'border-slate-200 hover:border-blue-300'
                                                }`}>
                                                    <input type="radio" name="pattern" value={opt.value}
                                                        checked={patternData.pattern_primario === opt.value}
                                                        onChange={(e) => setPatternData({...patternData, pattern_primario: e.target.value})}
                                                        className="mt-1 mr-3" />
                                                    <div>
                                                        <div className="font-semibold">{opt.label}</div>
                                                        <div className="text-sm text-slate-600">{opt.desc}</div>
                                                    </div>
                                                </label>
                                            ))}
                                        </div>

                                        <button onClick={() => setStep(2)} disabled={!patternData.pattern_primario}
                                            className="mt-6 w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-slate-300">
                                            Avanti ‚Üí
                                        </button>
                                    </div>
                                )}

                                {step === 2 && (
                                    <div>
                                        <h2 className="text-2xl font-bold mb-4">Epidermide</h2>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block font-semibold mb-2">Spongiosi</label>
                                                <select value={patternData.spongiosi}
                                                    onChange={(e) => setPatternData({...patternData, spongiosi: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assente">Assente</option>
                                                    <option value="lieve">Lieve</option>
                                                    <option value="moderata">Moderata</option>
                                                    <option value="marcata">Marcata</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Esocitosi</label>
                                                <select value={patternData.esocitosi}
                                                    onChange={(e) => setPatternData({...patternData, esocitosi: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assente">Assente</option>
                                                    <option value="lieve">Lieve</option>
                                                    <option value="presente">Presente</option>
                                                    <option value="marcata">Marcata</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Acantosi</label>
                                                <select value={patternData.acantosi}
                                                    onChange={(e) => setPatternData({...patternData, acantosi: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assente">Assente</option>
                                                    <option value="lieve">Lieve</option>
                                                    <option value="moderata">Moderata</option>
                                                    <option value="marcata">Marcata</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Paracheratosi</label>
                                                <select value={patternData.paracheratosi}
                                                    onChange={(e) => setPatternData({...patternData, paracheratosi: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assente">Assente</option>
                                                    <option value="focale">Focale</option>
                                                    <option value="moderata">Moderata</option>
                                                    <option value="marcata">Marcata</option>
                                                </select>
                                            </div>

                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block font-semibold mb-2">Ipergranulosi</label>
                                                    <select value={patternData.ipergranulosi}
                                                        onChange={(e) => setPatternData({...patternData, ipergranulosi: e.target.value})}
                                                        className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                        <option value="">Seleziona...</option>
                                                        <option value="no">No</option>
                                                        <option value="si">S√¨</option>
                                                    </select>
                                                </div>

                                                <div>
                                                    <label className="block font-semibold mb-2">Ipogranulosi</label>
                                                    <select value={patternData.ipogranulosi}
                                                        onChange={(e) => setPatternData({...patternData, ipogranulosi: e.target.value})}
                                                        className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                        <option value="">Seleziona...</option>
                                                        <option value="no">No</option>
                                                        <option value="si">S√¨</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Vacuolizzazione basale</label>
                                                <select value={patternData.vacuolizzazione_basale}
                                                    onChange={(e) => setPatternData({...patternData, vacuolizzazione_basale: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assente">Assente</option>
                                                    <option value="presente">Presente</option>
                                                    <option value="marcata">Marcata</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Necrosi cheratinociti</label>
                                                <select value={patternData.necrosi_keratinociti}
                                                    onChange={(e) => setPatternData({...patternData, necrosi_keratinociti: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assente">Assente</option>
                                                    <option value="presente">Presente</option>
                                                    <option value="marcata">Marcata</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div className="flex gap-4 mt-6">
                                            <button onClick={() => setStep(1)}
                                                className="flex-1 bg-slate-200 py-3 rounded-lg font-semibold">
                                                ‚Üê Indietro
                                            </button>
                                            <button onClick={() => setStep(3)}
                                                className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold">
                                                Avanti ‚Üí
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {step === 3 && (
                                    <div>
                                        <h2 className="text-2xl font-bold mb-4">Derma e Infiltrato</h2>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block font-semibold mb-2">Distribuzione infiltrato</label>
                                                <select value={patternData.infiltrato_distribuzione}
                                                    onChange={(e) => setPatternData({...patternData, infiltrato_distribuzione: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="perivascolare_superficiale">Perivascolare superficiale</option>
                                                    <option value="perivascolare_profondo">Perivascolare profondo</option>
                                                    <option value="banda_lichenoide">A banda lichenoide</option>
                                                    <option value="interstiziale">Interstiziale</option>
                                                    <option value="perivascolare_perianessiale">Perivascolare e perianessiale</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Densit√† infiltrato</label>
                                                <select value={patternData.infiltrato_densita}
                                                    onChange={(e) => setPatternData({...patternData, infiltrato_densita: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="scarso">Scarso</option>
                                                    <option value="moderato">Moderato</option>
                                                    <option value="denso">Denso</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Eosinofili</label>
                                                <select value={patternData.eosinofili}
                                                    onChange={(e) => setPatternData({...patternData, eosinofili: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assenti">Assenti</option>
                                                    <option value="rari">Rari</option>
                                                    <option value="presenti">Presenti</option>
                                                    <option value="abbondanti">Abbondanti</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Neutrofili</label>
                                                <select value={patternData.neutrofili}
                                                    onChange={(e) => setPatternData({...patternData, neutrofili: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assenti">Assenti</option>
                                                    <option value="rari">Rari</option>
                                                    <option value="presenti">Presenti</option>
                                                    <option value="abbondanti">Abbondanti</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Eritrociti extravasati</label>
                                                <select value={patternData.eritrociti_extravasati}
                                                    onChange={(e) => setPatternData({...patternData, eritrociti_extravasati: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="assenti">Assenti</option>
                                                    <option value="presenti">Presenti</option>
                                                    <option value="abbondanti">Abbondanti</option>
                                                </select>
                                            </div>

                                            <div className="p-4 bg-red-50 border-2 border-red-200 rounded-lg mt-4">
                                                <h3 className="font-bold text-red-900 mb-3">‚ö†Ô∏è Sospetto Linfoma?</h3>
                                                
                                                <div className="space-y-3">
                                                    <div>
                                                        <label className="block font-semibold mb-2">Linfociti atipici</label>
                                                        <select value={patternData.linfociti_atipici}
                                                            onChange={(e) => setPatternData({...patternData, linfociti_atipici: e.target.value})}
                                                            className="w-full p-3 border-2 border-red-200 rounded-lg focus:border-red-500 focus:outline-none">
                                                            <option value="">Seleziona...</option>
                                                            <option value="assenti">Assenti</option>
                                                            <option value="presenti">Presenti</option>
                                                            <option value="abbondanti">Abbondanti</option>
                                                        </select>
                                                    </div>

                                                    <div>
                                                        <label className="block font-semibold mb-2">Epidermotropismo</label>
                                                        <select value={patternData.epidermotropismo}
                                                            onChange={(e) => setPatternData({...patternData, epidermotropismo: e.target.value})}
                                                            className="w-full p-3 border-2 border-red-200 rounded-lg focus:border-red-500 focus:outline-none">
                                                            <option value="">Seleziona...</option>
                                                            <option value="assente">Assente</option>
                                                            <option value="presente">Presente</option>
                                                            <option value="marcato">Marcato</option>
                                                        </select>
                                                    </div>

                                                    <label className="flex items-center p-3 border-2 border-red-200 rounded-lg cursor-pointer hover:bg-red-100">
                                                        <input type="checkbox" checked={patternData.alone_chiaro}
                                                            onChange={(e) => setPatternData({...patternData, alone_chiaro: e.target.checked})}
                                                            className="mr-3" />
                                                        <span>Alone chiaro perinucleare</span>
                                                    </label>

                                                    <label className="flex items-center p-3 border-2 border-red-200 rounded-lg cursor-pointer hover:bg-red-100">
                                                        <input type="checkbox" checked={patternData.cellule_cerebriformi}
                                                            onChange={(e) => setPatternData({...patternData, cellule_cerebriformi: e.target.checked})}
                                                            className="mr-3" />
                                                        <span>Cellule cerebriformi</span>
                                                    </label>

                                                    <label className="flex items-center p-3 border-2 border-red-200 rounded-lg cursor-pointer hover:bg-red-100">
                                                        <input type="checkbox" checked={patternData.cd30_positivi}
                                                            onChange={(e) => setPatternData({...patternData, cd30_positivi: e.target.checked})}
                                                            className="mr-3" />
                                                        <span>CD30+ (se IHC disponibile)</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex gap-4 mt-6">
                                            <button onClick={() => setStep(2)}
                                                className="flex-1 bg-slate-200 py-3 rounded-lg font-semibold">
                                                ‚Üê Indietro
                                            </button>
                                            <button onClick={() => setStep(4)}
                                                className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold">
                                                Avanti ‚Üí
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {step === 4 && (
                                    <div>
                                        <h2 className="text-2xl font-bold mb-4">Completamento</h2>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block font-semibold mb-2">Vasculite</label>
                                                <select value={patternData.vasculite}
                                                    onChange={(e) => setPatternData({...patternData, vasculite: e.target.value})}
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                                    <option value="">Seleziona...</option>
                                                    <option value="no">No</option>
                                                    <option value="si">S√¨</option>
                                                </select>
                                            </div>

                                            <label className="flex items-center p-3 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                                <input type="checkbox" checked={patternData.microascessi_munro}
                                                    onChange={(e) => setPatternData({...patternData, microascessi_munro: e.target.checked})}
                                                    className="mr-3" />
                                                <span>Microascessi di Munro</span>
                                            </label>

                                            <div>
                                                <label className="block font-semibold mb-2">Sede anatomica</label>
                                                <input type="text" value={patternData.sede_anatomica}
                                                    onChange={(e) => setPatternData({...patternData, sede_anatomica: e.target.value})}
                                                    placeholder="es. avambraccio sinistro"
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Note cliniche</label>
                                                <textarea value={patternData.note_cliniche}
                                                    onChange={(e) => setPatternData({...patternData, note_cliniche: e.target.value})}
                                                    placeholder="Contesto clinico, durata, terapie..."
                                                    className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none h-24" />
                                            </div>
                                        </div>

                                        <div className="flex gap-4 mt-6">
                                            <button onClick={() => setStep(3)}
                                                className="flex-1 bg-slate-200 py-3 rounded-lg font-semibold">
                                                ‚Üê Indietro
                                            </button>
                                            <button onClick={calculateDiagnoses}
                                                className="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                                                ‚úì Genera Diagnosi
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {showResults && (
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <div className="flex items-center justify-between mb-6">
                                    <h2 className="text-2xl font-bold">üìã Diagnosi Differenziale</h2>
                                    <div className="flex gap-2">
                                        <button onClick={generateReport}
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">
                                            üíæ Esporta
                                        </button>
                                        <button onClick={() => setShowResults(false)}
                                            className="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 text-sm font-semibold">
                                            ‚Üê Modifica
                                        </button>
                                    </div>
                                </div>

                                {diagnoses.length === 0 && (
                                    <div className="p-6 bg-amber-50 border-2 border-amber-200 rounded-lg text-center">
                                        <p className="font-semibold text-amber-900">‚ö†Ô∏è Nessuna diagnosi compatibile</p>
                                        <p className="text-sm text-amber-800 mt-2">Rivedi i parametri inseriti</p>
                                    </div>
                                )}

                                {diagnoses.some(d => d.categoria.includes('Linfoma')) && (
                                    <div className="mb-6 p-4 bg-red-50 border-2 border-red-500 rounded-lg">
                                        <h3 className="text-lg font-bold text-red-900 mb-2">‚ö†Ô∏è SOSPETTO LINFOMA</h3>
                                        <div className="text-sm text-red-800 space-y-1">
                                            <p><strong>‚Ä¢ IHC:</strong> CD3, CD4, CD8, CD20, CD30, CD7, Ki67</p>
                                            <p><strong>‚Ä¢ PCR:</strong> Riarrangiamento TCR o IgH</p>
                                            <p><strong>‚Ä¢ Staging:</strong> TC, emocromo, LDH</p>
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-4">
                                    {diagnoses.map((d, i) => {
                                        const isLymphoma = d.categoria.includes('Linfoma');
                                        
                                        return (
                                            <div key={i} className={`border-2 rounded-lg p-5 ${
                                                isLymphoma ? 'border-red-500 bg-red-50' :
                                                i === 0 ? 'border-green-500 bg-green-50' : 
                                                'border-slate-200'
                                            }`}>
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <h3 className="text-xl font-bold">{d.nome}</h3>
                                                            {isLymphoma && (
                                                                <span className="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">
                                                                    LINFOMA
                                                                </span>
                                                            )}
                                                        </div>
                                                        <p className="text-sm text-slate-600">{d.categoria}</p>
                                                    </div>
                                                    <div className="text-3xl font-bold text-blue-600 ml-4">
                                                        {d.percentuale}%
                                                    </div>
                                                </div>

                                                <p className="text-sm mb-3 bg-white rounded p-3">{d.note}</p>

                                                {d.colorazioni.length > 0 && (
                                                    <div className={`rounded p-3 mb-2 ${
                                                        isLymphoma ? 'bg-red-100' : 'bg-amber-50'
                                                    }`}>
                                                        <p className="text-sm font-semibold mb-1">üî¨ {isLymphoma ? 'IHC OBBLIGATORIA' : 'Colorazioni'}:</p>
                                                        <ul className="text-sm space-y-1">
                                                            {d.colorazioni.map((c, idx) => <li key={idx}>‚Ä¢ {c}</li>)}
                                                        </ul>
                                                    </div>
                                                )}

                                                {d.workup_molecolare && (
                                                    <div className="bg-purple-50 rounded p-3">
                                                        <p className="text-sm"><strong>üß¨ Molecolare:</strong> {d.workup_molecolare}</p>
                                                    </div>
                                                )}

                                                <p className="text-xs text-slate-500 italic mt-3">üìö {d.bibliografia}</p>
                                            </div>
                                        );
                                    })}
                                </div>

                                <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-sm text-blue-900">
                                        <strong>üí° Nota:</strong> Diagnosi differenziale pattern-based. 
                                        La diagnosi definitiva richiede correlazione clinico-patologica.
                                    </p>
                                </div>
                            </div>
                        )}

                        <div className="mt-6 text-center text-sm text-slate-600">
                            <p>DermPath v1.0 - Pattern-based diagnostic system</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DermPathDiagnostic />, document.getElementById('root'));
    </script>
</body>
</html>